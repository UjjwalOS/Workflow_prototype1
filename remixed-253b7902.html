<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDMS v6 - Role-Based Views</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* =============================================
           DESIGN TOKENS
           ============================================= */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --success: #16a34a;
            --success-light: #f0fdf4;
            --warning: #f59e0b;
            --warning-light: #fffbeb;
            --danger: #dc2626;
            --danger-light: #fef2f2;
            --purple: #7c3aed;
            --purple-light: #f5f3ff;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        .app { display: flex; height: 100vh; }

        /* =============================================
           SIDEBAR
           ============================================= */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
        }

        .reset-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s;
        }

        .reset-btn:hover { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }
        .reset-btn:active { transform: scale(0.97); }

        .search-box { padding: 12px 16px; border-bottom: 1px solid var(--gray-200); }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: 8px 12px;
            transition: all 0.15s;
        }

        .search-input-wrapper:focus-within {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .search-input-wrapper .material-icons-outlined { font-size: 18px; color: var(--gray-400); }
        .search-input { flex: 1; border: none; background: transparent; font-size: 13px; outline: none; }
        .search-shortcut { font-size: 10px; font-weight: 500; color: var(--gray-400); background: var(--gray-200); padding: 2px 5px; border-radius: 4px; }

        .role-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .role-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 10px;
        }

        .role-selector { display: flex; gap: 6px; margin-bottom: 10px; }

        .role-avatar-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
            position: relative;
        }

        .role-avatar-btn:hover { transform: scale(1.1); }
        .role-avatar-btn.active { border-color: var(--gray-900); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--gray-900); }

        .role-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 9px;
            font-weight: 700;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .current-role-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .current-role-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .current-role-name { font-size: 13px; font-weight: 600; color: var(--gray-900); }
        .current-role-title { font-size: 11px; color: var(--gray-500); }

        .tooltip { position: relative; }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: var(--gray-900);
            color: white;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            border-radius: var(--radius-sm);
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            margin-bottom: 6px;
            z-index: 100;
        }
        .tooltip:hover::after { opacity: 1; visibility: visible; }

        .queue-section { flex: 1; overflow-y: auto; padding: 16px; }

        .queue-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-empty { text-align: center; padding: 32px 16px; color: var(--gray-400); }
        .queue-empty-icon { font-size: 40px; margin-bottom: 8px; }

        .queue-item {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
        }

        .queue-item:hover { border-color: var(--gray-300); box-shadow: var(--shadow-sm); }
        .queue-item.active { border-color: var(--primary); background: var(--primary-light); }

        .queue-priority { width: 4px; border-radius: 2px; flex-shrink: 0; }
        .queue-priority.high { background: var(--danger); }
        .queue-priority.medium { background: var(--warning); }
        .queue-priority.low { background: var(--success); }

        .queue-content { flex: 1; min-width: 0; }
        .queue-doc-title { font-size: 13px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px; }
        .queue-doc-meta { font-size: 11px; color: var(--gray-500); margin-bottom: 8px; }

        .queue-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 100px;
            background: var(--warning-light);
            color: #b45309;
        }

        /* =============================================
           MAIN CONTENT
           ============================================= */
        .main-content { flex: 1; display: flex; min-width: 0; }

        .doc-viewer {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: #525659;
        }

        .doc-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: #3c3f42;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .doc-tabs { display: flex; gap: 4px; overflow-x: auto; }

        .doc-tab {
            padding: 8px 14px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .doc-tab:hover { background: rgba(255,255,255,0.15); color: white; }
        .doc-tab.active { background: var(--primary); color: white; }

        .doc-control-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .doc-control-btn:hover { background: rgba(255,255,255,0.2); color: white; }

        .doc-body {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            overflow: auto;
            background: #e5e7eb;
        }

        .doc-page {
            background: white;
            width: 100%;
            max-width: 800px;
            padding: 60px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .doc-page h1 { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 8px; }
        .doc-page .subtitle { font-size: 14px; color: var(--gray-500); text-align: center; margin-bottom: 40px; }
        .doc-page h2 { font-size: 16px; font-weight: 600; margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 2px solid var(--gray-200); }
        .doc-page p { font-size: 14px; color: var(--gray-700); margin-bottom: 12px; line-height: 1.7; }
        .doc-page ul { margin: 12px 0 12px 24px; }
        .doc-page li { font-size: 14px; color: var(--gray-700); margin-bottom: 8px; }
        .doc-page table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; }
        .doc-page th, .doc-page td { padding: 10px 12px; text-align: left; border: 1px solid var(--gray-200); }
        .doc-page th { background: var(--gray-100); font-weight: 600; }

        /* =============================================
           DETAILS PANEL
           ============================================= */
        .details-panel {
            width: 400px;
            background: white;
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .panel-header {
            display: flex;
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .panel-tabs { display: flex; gap: 4px; }

        .panel-tab {
            padding: 8px 14px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.15s;
        }

        .panel-tab:hover { color: var(--gray-700); background: white; }
        .panel-tab.active { background: white; color: var(--gray-900); box-shadow: var(--shadow-sm); }

        .panel-body { flex: 1; overflow-y: auto; padding: 16px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .quick-actions { display: flex; gap: 8px; margin-bottom: 16px; }

        /* Pending Action Banner - Role Specific */
        .banner-pending {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
        }

        .banner-pending-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--warning);
            flex-shrink: 0;
        }

        .banner-pending-title { font-size: 14px; font-weight: 600; color: var(--gray-900); }
        .banner-pending-subtitle { font-size: 12px; color: var(--gray-600); margin-top: 2px; }

        /* Work Assigned Banner (AO specific) */
        .banner-work-assigned {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: linear-gradient(135deg, var(--primary-light) 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
        }

        .banner-work-assigned .banner-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            flex-shrink: 0;
        }

        .banner-closed {
            background: var(--success-light);
            border: 1px solid #86efac;
            border-radius: var(--radius-lg);
            text-align: center;
            padding: 24px;
            margin-bottom: 12px;
        }

        .banner-closed .material-icons-outlined { font-size: 48px; color: var(--success); margin-bottom: 8px; display: block; }
        .banner-closed h3 { font-size: 18px; color: var(--success); margin-bottom: 4px; }
        .banner-closed p { font-size: 13px; color: var(--gray-600); }

        /* Currently With */
        .current-holder {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .current-holder:hover { border-color: var(--primary); background: var(--primary-light); }
        .current-holder:hover .holder-hint { opacity: 1; }

        .holder-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .holder-label { font-size: 11px; font-weight: 500; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; }
        .holder-name { font-size: 14px; font-weight: 600; color: var(--gray-900); }
        .holder-role { font-size: 12px; color: var(--gray-500); }

        .holder-you-badge {
            background: var(--primary);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 100px;
        }

        .holder-hint {
            position: absolute;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--primary);
            opacity: 0;
            transition: opacity 0.15s;
        }

        /* Status Card */
        .status-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .status-row:not(:last-child) { border-bottom: 1px solid var(--gray-100); }
        .status-label { font-size: 12px; color: var(--gray-500); }

        .priority-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-badge.high { background: var(--danger-light); color: var(--danger); }
        .priority-badge.medium { background: var(--warning-light); color: #b45309; }
        .priority-badge.low { background: var(--success-light); color: var(--success); }
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .status-value { font-size: 13px; font-weight: 500; color: var(--gray-700); }

        /* Priority Dropdown */
        .priority-dropdown { position: relative; cursor: pointer; }
        .priority-dropdown .priority-badge { cursor: pointer; }
        .priority-dropdown .priority-badge:hover { opacity: 0.8; }
        
        .priority-options {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
            min-width: 120px;
        }
        
        .priority-options.show { display: block; }
        
        .priority-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .priority-option:hover { background: var(--gray-50); }
        .priority-option.active { background: var(--gray-100); }
        .priority-option:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
        .priority-option:last-child { border-radius: 0 0 var(--radius-md) var(--radius-md); }

        /* Deadline Warnings */
        .deadline-warning {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            padding: 2px 8px;
            background: var(--danger-light);
            color: var(--danger);
            font-size: 11px;
            font-weight: 600;
            border-radius: 100px;
        }
        
        .deadline-warning.warning {
            background: var(--warning-light);
            color: #b45309;
        }
        
        .status-value.deadline-danger { color: var(--danger); font-weight: 600; }
        .status-value.deadline-warning { color: #b45309; }

        /* =============================================
           COLLAPSIBLE SECTIONS
           ============================================= */
        .section-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            overflow: hidden;
        }

        .section-card.highlight { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary-light); }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .section-header:hover { background: var(--gray-50); }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .section-count {
            background: var(--gray-200);
            color: var(--gray-600);
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 100px;
        }

        .section-toggle { color: var(--gray-400); transition: transform 0.2s; }
        .section-card.expanded .section-toggle { transform: rotate(180deg); }
        
        .section-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--primary-light);
            border: none;
            border-radius: 6px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .section-action-btn:hover { background: var(--primary); color: white; }
        .section-action-btn .material-icons-outlined { font-size: 16px; }
        
        .section-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .section-card.expanded .section-content { max-height: 2000px; }
        .section-body { padding: 0 16px 16px; }

        .see-all-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 10px;
            margin-top: 8px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .see-all-link:hover { background: var(--primary-light); }

        /* AI Summary - Normal card style */
        .ai-summary {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 12px;
        }

        .ai-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ai-summary-header:hover { background: var(--gray-50); }

        .ai-summary-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .ai-summary-title .material-icons-outlined {
            color: var(--purple);
        }

        .ai-summary-content {
            padding: 0 16px 16px;
            font-size: 13px;
            color: var(--gray-700);
            line-height: 1.7;
            display: none;
        }

        .ai-summary.expanded .ai-summary-content { display: block; }
        .expand-icon { color: var(--gray-400); transition: transform 0.2s; }
        .ai-summary.expanded .expand-icon { transform: rotate(180deg); }

        .ask-ai-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            margin-top: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ask-ai-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* =============================================
           TASK VIEWS - ROLE BASED
           ============================================= */
        
        /* AO View: Interactive Checkboxes */
        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .task-item:last-child { border-bottom: none; }

        .task-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--gray-300);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s;
            background: white;
        }

        .task-checkbox:hover { border-color: var(--primary); }
        .task-checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .task-checkbox.checked .material-icons-outlined { color: white; font-size: 16px; }

        .task-title { font-size: 13px; font-weight: 500; color: var(--gray-800); }
        .task-item.completed .task-title { text-decoration: line-through; color: var(--gray-500); }
        .task-meta { font-size: 11px; color: var(--gray-500); margin-top: 2px; }

        /* CS View: Progress Tracking */
        .progress-tracker {
            padding: 4px 0;
        }

        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .progress-stats {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .progress-bar-container {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #22c55e 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
        }

        .progress-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .progress-indicator.done {
            background: var(--success);
            color: white;
        }

        .progress-indicator.done .material-icons-outlined {
            font-size: 14px;
        }

        .progress-indicator.pending {
            background: transparent;
            border: 2px solid var(--gray-300);
        }

        .progress-task-title {
            font-size: 13px;
            color: var(--gray-700);
        }

        .progress-item.done .progress-task-title {
            color: var(--gray-500);
        }

        .progress-assignee {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-100);
            font-size: 12px;
            color: var(--gray-500);
        }

        .progress-assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: white;
        }

        /* EA/DTO View: Minimal Summary */
        .tasks-summary {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: var(--radius-md);
        }

        .tasks-summary-icon {
            width: 40px;
            height: 40px;
            background: var(--purple-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--purple);
        }

        .tasks-summary-text {
            font-size: 13px;
            color: var(--gray-700);
        }

        .tasks-summary-text strong {
            color: var(--gray-900);
        }

        /* Comments */
        .comment-item { padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
        .comment-item:last-child { border-bottom: none; }

        .comment-header { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }

        .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .comment-author { font-size: 13px; font-weight: 600; color: var(--gray-900); }
        .comment-time { font-size: 11px; color: var(--gray-500); }
        .comment-text { font-size: 13px; color: var(--gray-700); line-height: 1.6; margin-left: 38px; margin-top: 4px; }
        
        .comment-meta-wrapper { display: flex; flex-direction: column; gap: 4px; }
        
        .comment-author-line {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .comment-arrow {
            color: var(--gray-400);
            font-size: 12px;
            font-weight: 500;
        }
        
        .comment-recipient {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            color: white;
            font-size: 9px;
            font-weight: 600;
        }
        
        .comment-linked-doc {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--primary-light);
            color: var(--primary);
            font-size: 11px;
            font-weight: 500;
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.15s;
            width: fit-content;
        }
        
        .comment-linked-doc:hover { background: #dbeafe; }

        /* Document Card - Linear/Stripe inspired design */
        .doc-card {
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .doc-card:last-child { margin-bottom: 0; }
        
        .doc-card:hover {
            border-color: var(--gray-300);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        }
        
        .doc-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.02) 0%, rgba(37, 99, 235, 0.04) 100%);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }
        
        .doc-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .doc-card-icon.pdf { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; }
        .doc-card-icon.excel { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #16a34a; }
        .doc-card-icon.word { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #2563eb; }
        .doc-card-icon .material-icons-outlined { font-size: 20px; }
        
        .doc-card-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .doc-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .doc-card-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-900);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        .doc-card-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .doc-card-badge.original { 
            background: var(--primary); 
            color: white; 
        }
        .doc-card-badge.draft { 
            background: var(--gray-100); 
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }
        .doc-card-badge.submitted { 
            background: var(--success-light); 
            color: var(--success); 
        }
        .doc-card-badge.received {
            background: #dbeafe;
            color: #1d4ed8;
        }
        .doc-card-badge.revision {
            background: #fef3c7;
            color: #b45309;
        }
        .doc-card-badge.new {
            background: #fef3c7;
            color: #b45309;
            animation: gentle-pulse 2s infinite;
        }
        
        .doc-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .doc-card-meta-dot {
            width: 3px;
            height: 3px;
            background: var(--gray-300);
            border-radius: 50%;
        }
        
        .doc-card-actions {
            position: absolute;
            right: 12px;
            bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transform: translateX(4px);
            transition: all 0.15s ease;
        }
        
        .doc-card:hover .doc-card-actions {
            opacity: 1;
            transform: translateX(0);
        }
        
        .doc-card.active .doc-card-actions {
            opacity: 1;
            transform: translateX(0);
        }
        
        .doc-card-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .doc-card-action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        
        .doc-card-action-btn .material-icons-outlined {
            font-size: 16px;
            color: var(--gray-600);
        }
        
        .doc-card-action-btn:hover .material-icons-outlined {
            color: var(--primary);
        }
        
        .doc-card-viewing {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            color: var(--primary);
            padding: 4px 8px;
            background: var(--primary-light);
            border-radius: 4px;
        }
        
        .doc-card-viewing::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--gray-400);
            font-size: 13px;
        }

        /* =============================================
           EVENT LOG - ACTIVITY TIMELINE
           ============================================= */
        .event-log { 
            display: flex; 
            flex-direction: column; 
            position: relative;
            padding-left: 8px;
        }

        .event-item {
            display: flex;
            gap: 16px;
            padding: 16px 8px 20px 32px;
            position: relative;
            transition: background 0.15s;
        }

        .event-item:hover { background: var(--gray-50); border-radius: var(--radius-md); }
        .event-item.highlighted { background: var(--warning-light); }

        /* Timeline line */
        .event-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 13px;
            top: 32px;
            bottom: 0;
            width: 2px;
            background: var(--gray-200);
        }

        /* Timeline dot */
        .event-dot {
            position: absolute;
            left: 8px;
            top: 18px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-300);
            border: 2px solid white;
            box-shadow: 0 0 0 1px var(--gray-200);
            z-index: 2;
        }

        /* Dot states */
        .event-dot.completed { background: var(--gray-400); }
        .event-dot.active { background: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2); }
        .event-dot.milestone { background: white; border: 2px solid var(--primary); box-shadow: 0 0 0 1px var(--primary); }
        .event-dot.approved { background: #10b981; }
        .event-dot.rejected { background: #ef4444; }
        .event-dot.sent-back { background: #ef4444; }
        
        /* "Involves you" indicator */
        .event-dot.involves-you::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            border: 1px solid white;
        }

        .event-content { flex: 1; min-width: 0; }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        /* Action line: [Actor] verb to [Target] */
        .event-action-line { 
            font-size: 14px; 
            color: var(--gray-700);
            line-height: 1.4;
        }
        
        .event-actor, .event-target {
            color: var(--primary);
            font-weight: 500;
            cursor: default;
        }
        
        .event-actor:hover, .event-target:hover {
            text-decoration: underline;
        }
        
        .event-actor.is-you, .event-target.is-you {
            font-weight: 600;
        }
        
        .event-verb {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .event-suffix {
            color: var(--gray-500);
        }

        .event-time { 
            font-size: 12px; 
            color: var(--gray-500); 
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Terminal status badge */
        .event-status-badge {
            padding: 3px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .event-status-badge.completed {
            background: #d1fae5;
            color: #047857;
        }
        
        .event-status-badge.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Duration badge */
        .event-duration {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            color: white;
        }
        
        .event-duration .material-icons-outlined {
            font-size: 12px;
        }
        
        .event-duration.fast { background: #22c55e; }
        .event-duration.normal { background: #f59e0b; }
        .event-duration.slow { background: #ef4444; }

        /* Notes block (gray) - clickable */
        .event-note {
            font-size: 13px;
            color: var(--gray-600);
            line-height: 1.6;
            margin-top: 10px;
            padding: 12px;
            background: #f8f9fa;
            border: 1px solid #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .event-note:hover {
            background: #f1f5f9;
            border-color: var(--primary);
        }
        
        /* Instructions block (yellow - for delegations) */
        .event-instructions {
            margin-top: 10px;
            padding: 12px 14px;
            background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
            border-left: 3px solid #f59e0b;
            border-radius: 0 8px 8px 0;
        }
        
        .event-instructions-label {
            font-size: 10px;
            font-weight: 700;
            color: #92400e;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        
        .event-instructions-text {
            font-size: 13px;
            color: #78350f;
            line-height: 1.5;
        }

        /* Attachment card in event */
        .event-attachment {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 10px;
            padding: 10px 12px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .event-attachment:hover {
            border-color: var(--primary);
        }
        
        .event-attachment-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .event-attachment-icon.pdf { background: #fee2e2; color: #dc2626; }
        .event-attachment-icon.word { background: #dbeafe; color: #2563eb; }
        .event-attachment-icon.excel { background: #d1fae5; color: #047857; }
        
        .event-attachment-info { flex: 1; min-width: 0; }
        .event-attachment-name { font-size: 13px; font-weight: 500; color: var(--gray-800); }
        .event-attachment-size { font-size: 11px; color: var(--gray-500); }
        
        .event-attachment-download {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: var(--gray-400);
            transition: all 0.15s;
        }
        
        .event-attachment:hover .event-attachment-download {
            background: var(--gray-100);
            color: var(--primary);
        }

        /* Revision label */
        .event-revision-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px 10px;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: #92400e;
        }
        
        .event-revision-label .material-icons-outlined {
            font-size: 12px;
        }

        .show-more-events {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--gray-50);
            border: 1px dashed var(--gray-300);
            border-radius: var(--radius-md);
            margin: 8px 0 8px 32px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
        }

        .show-more-events:hover { background: var(--gray-100); }

        /* =============================================
           DOCUMENTS TAB - ROLE-BASED VIEWS
           ============================================= */
        
        /* Document Section Headers */
        .doc-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .doc-section { margin-bottom: 24px; }
        .doc-section:last-child { margin-bottom: 0; }
        
        /* Submission Group - For CS viewing received work */
        .submission-group {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .submission-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .submission-sender-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .submission-sender-info {
            flex: 1;
            min-width: 0;
        }
        
        .submission-sender-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .submission-sender-meta {
            font-size: 12px;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .submission-context {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: var(--gray-500);
            padding: 4px 10px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 100px;
        }
        
        .submission-context .material-icons-outlined {
            font-size: 14px;
        }
        
        /* NEW badge for unread documents */
        .doc-badge-new {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: #fef3c7;
            color: #b45309;
            border-radius: 4px;
            animation: gentle-pulse 2s infinite;
        }
        
        @keyframes gentle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .doc-badge-new::before {
            content: '';
            width: 5px;
            height: 5px;
            background: #f59e0b;
            border-radius: 50%;
        }
        
        /* Revision indicator */
        .doc-revision-badge {
            font-size: 10px;
            font-weight: 500;
            color: var(--gray-500);
            padding: 2px 6px;
            background: var(--gray-100);
            border-radius: 4px;
        }
        
        /* Previous submissions - collapsed view */
        .previous-submissions {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px dashed var(--gray-300);
        }
        
        .previous-submissions-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gray-500);
            cursor: pointer;
            padding: 8px 0;
            transition: color 0.15s;
        }
        
        .previous-submissions-header:hover {
            color: var(--gray-700);
        }
        
        .previous-submissions-header .material-icons-outlined {
            font-size: 18px;
            transition: transform 0.2s;
        }
        
        .previous-submissions.expanded .previous-submissions-header .material-icons-outlined {
            transform: rotate(180deg);
        }
        
        .previous-submissions-list {
            display: none;
            margin-top: 8px;
        }
        
        .previous-submissions.expanded .previous-submissions-list {
            display: block;
        }
        
        .previous-doc-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .previous-doc-item:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }
        
        .previous-doc-item .material-icons-outlined {
            font-size: 18px;
            color: var(--gray-400);
        }
        
        .previous-doc-name {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .previous-doc-status {
            font-size: 10px;
            color: var(--gray-500);
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: 4px;
        }

        /* Documents Tab - Full list view (Linear/Stripe inspired) */
        .document-card {
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 16px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 10px;
        }
        
        .document-card:last-child { margin-bottom: 0; }

        .document-card:hover { 
            border-color: var(--gray-300); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
        }
        .document-card.active { 
            border-color: var(--primary); 
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.02) 0%, rgba(37, 99, 235, 0.04) 100%);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        }
        .document-card.original { border-left: 3px solid var(--primary); }
        .document-card.has-new { border-left: 3px solid #f59e0b; }

        .doc-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .doc-icon.pdf { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626; }
        .doc-icon.excel { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #16a34a; }
        .doc-icon.word { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #2563eb; }
        .doc-icon .material-icons-outlined { font-size: 22px; }

        .doc-details { flex: 1; min-width: 0; }
        .doc-name { font-size: 14px; font-weight: 600; color: var(--gray-900); margin-bottom: 4px; }
        .doc-meta { font-size: 12px; color: var(--gray-500); margin-bottom: 8px; }
        
        .doc-badges {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .doc-status {
            display: inline-block;
            padding: 3px 10px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .doc-status.original { background: var(--primary); color: white; }
        .doc-status.draft { background: var(--gray-100); color: var(--gray-600); border: 1px solid var(--gray-200); }
        .doc-status.submitted { background: var(--success-light); color: var(--success); }
        .doc-status.received { background: #dbeafe; color: #1d4ed8; }
        .doc-status.revision { background: #fef3c7; color: #b45309; }

        .doc-action-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.15s;
        }

        .doc-action-btn:hover { 
            background: var(--primary-light); 
            border-color: var(--primary);
            color: var(--primary); 
        }
        
        /* Document source indicator */
        .doc-source {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 6px;
        }
        
        .doc-source-avatar {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 8px;
            font-weight: 600;
        }
        
        /* Empty state with context */
        .doc-empty-state {
            text-align: center;
            padding: 32px 20px;
            color: var(--gray-400);
        }
        
        .doc-empty-state .material-icons-outlined {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .doc-empty-state-text {
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .doc-empty-state-hint {
            font-size: 12px;
            color: var(--gray-400);
        }

        /* =============================================
           ASK AI TAB
           ============================================= */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 200px); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message { display: flex; gap: 10px; max-width: 90%; }
        .chat-message.user { align-self: flex-end; flex-direction: row-reverse; }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple) 100%);
        }

        .chat-bubble { padding: 12px 16px; border-radius: var(--radius-lg); font-size: 13px; line-height: 1.6; }
        .chat-message.ai .chat-bubble { background: var(--gray-100); color: var(--gray-800); border-bottom-left-radius: 4px; }
        .chat-message.user .chat-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }

        .chat-input-area { display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--gray-200); }

        .chat-input-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
        }

        .chat-input-wrapper:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .chat-input { flex: 1; border: none; background: transparent; font-size: 13px; outline: none; }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
        }

        .chat-send-btn:hover { background: var(--primary-hover); }

        .quick-prompts { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }

        .quick-prompt {
            padding: 6px 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
        }

        .quick-prompt:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

        /* =============================================
           ACTION BAR
           ============================================= */
        .action-bar { padding: 16px; background: white; border-top: 1px solid var(--gray-200); }

        .action-bar-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--gray-600);
        }

        .primary-action {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 8px;
        }

        .primary-action:hover { background: var(--primary-hover); }
        .primary-action.success { background: var(--success); }
        .primary-action.success:hover { background: #15803d; }

        .secondary-actions { display: flex; gap: 8px; }

        .secondary-action {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 14px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        .secondary-action:hover { background: var(--gray-200); }
        .secondary-action.success { background: var(--success-light); color: var(--success); }
        .secondary-action.danger { background: var(--danger-light); color: var(--danger); }

        /* =============================================
           MODAL
           ============================================= */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title { font-size: 18px; font-weight: 600; color: var(--gray-900); }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--gray-400);
            cursor: pointer;
        }

        .modal-close:hover { background: var(--gray-100); color: var(--gray-600); }

        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 8px; }
        .form-helper { font-size: 11px; color: var(--gray-500); margin-top: 6px; }

        .form-select, .form-input, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 14px;
            color: var(--gray-800);
            transition: all 0.15s;
        }

        .form-select:focus, .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-textarea { min-height: 100px; resize: vertical; }

        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }

        .form-divider { height: 1px; background: var(--gray-200); margin: 20px 0; }

        .recipient-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
        }

        .recipient-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .recipient-name { font-size: 13px; font-weight: 600; color: var(--gray-900); }
        .recipient-role { font-size: 11px; color: var(--gray-500); }

        .radio-options { display: flex; flex-direction: column; gap: 8px; }

        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 14px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .radio-option:hover { border-color: var(--gray-300); }
        .radio-option.selected { border-color: var(--primary); background: var(--primary-light); }

        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .radio-option.selected .radio-circle { border-color: var(--primary); }

        .radio-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
            opacity: 0;
        }

        .radio-option.selected .radio-dot { opacity: 1; }

        .radio-label { font-size: 13px; font-weight: 500; color: var(--gray-700); }
        .radio-desc { font-size: 11px; color: var(--gray-500); margin-top: 2px; }

        .doc-select-list { display: flex; flex-direction: column; gap: 8px; }

        .doc-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .doc-select-item:hover { border-color: var(--gray-300); }
        .doc-select-item.selected { border-color: var(--primary); background: var(--primary-light); }

        .doc-select-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray-300);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .doc-select-item.selected .doc-select-checkbox { background: var(--primary); border-color: var(--primary); }
        .doc-select-item.selected .doc-select-checkbox .material-icons-outlined { color: white; font-size: 14px; }
        .doc-select-name { font-size: 13px; font-weight: 500; color: var(--gray-700); flex: 1; }
        .doc-select-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 100px; background: var(--gray-200); color: var(--gray-600); }

        .task-input-list { display: flex; flex-direction: column; gap: 8px; }

        .task-input-item { display: flex; align-items: center; gap: 8px; }

        .task-input-item input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 13px;
        }

        .task-input-item input:focus { outline: none; border-color: var(--primary); }

        .task-remove-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--gray-400);
            cursor: pointer;
        }

        .task-remove-btn:hover { background: var(--danger-light); color: var(--danger); }

        .add-task-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            background: var(--gray-50);
            border: 1px dashed var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--gray-600);
            cursor: pointer;
            margin-top: 8px;
        }

        .add-task-btn:hover { background: var(--gray-100); border-color: var(--gray-400); }

        .completed-tasks { display: flex; flex-direction: column; gap: 8px; }

        .completed-task {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--success-light);
            border-radius: var(--radius-sm);
        }

        .completed-task .material-icons-outlined { color: var(--success); font-size: 18px; }
        .completed-task span { font-size: 13px; color: var(--gray-700); }

        /* Task Summary in Send Modal */
        .task-summary-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .task-summary-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-200);
        }
        
        .task-summary-item.completed {
            background: var(--success-light);
            border-color: #bbf7d0;
        }
        
        .task-summary-item.incomplete {
            background: #fef3c7;
            border-color: #fcd34d;
        }
        
        .task-summary-title {
            flex: 1;
            font-size: 13px;
            color: var(--gray-700);
        }
        
        .task-summary-item.incomplete .task-summary-title {
            text-decoration: none;
        }
        
        .task-summary-status {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .task-summary-status.completed {
            background: #dcfce7;
            color: #15803d;
        }
        
        .task-summary-status.incomplete {
            background: #fef3c7;
            color: #92400e;
        }
        
        .task-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 12px;
            padding: 12px;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: #92400e;
            line-height: 1.5;
        }
        
        .task-warning .material-icons-outlined {
            font-size: 18px;
            color: #d97706;
            flex-shrink: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #15803d; }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }

        /* Rejection Warning */
        .rejection-warning {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }
        
        .rejection-warning .material-icons-outlined {
            color: var(--danger);
            font-size: 24px;
        }
        
        .rejection-warning strong {
            color: var(--danger);
        }

        /* Draft Warning in Modal */
        .draft-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            font-size: 13px;
            color: var(--primary);
        }
        
        .draft-warning .material-icons-outlined {
            font-size: 18px;
        }

        /* Document select item with draft highlight */
        .doc-select-item.is-draft {
            background: #eff6ff;
            border-color: #bfdbfe;
        }
        
        .doc-select-item.is-draft:hover {
            background: #dbeafe;
        }
        
        .doc-select-badge.draft {
            background: var(--primary-light);
            color: var(--primary);
        }
        
        .doc-select-badge.original {
            background: var(--gray-100);
            color: var(--gray-600);
        }
        
        .doc-select-badge.sent {
            background: var(--success-light);
            color: var(--success);
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            background: var(--gray-900);
            color: white;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ID</div>
                    <span>IDMS</span>
                </div>
                <button class="reset-btn" onclick="resetDemo()">
                    <span class="material-icons-outlined" style="font-size:14px">refresh</span>
                    <span>Reset</span>
                </button>
            </div>

            <div class="search-box">
                <div class="search-input-wrapper">
                    <span class="material-icons-outlined">search</span>
                    <input type="text" class="search-input" placeholder="Search cases..." id="search-input">
                    <span class="search-shortcut">K</span>
                </div>
            </div>

            <div class="role-section">
                <div class="role-label">Switch Role (Demo)</div>
                <div class="role-selector" id="role-selector"></div>
                <div class="current-role-info" id="current-role-info"></div>
            </div>

            <div class="queue-section">
                <div class="queue-title">
                    <span class="material-icons-outlined" style="font-size:16px">inbox</span>
                    Your Queue
                </div>
                <div id="document-queue"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="doc-viewer">
                <div class="doc-header">
                    <div class="doc-tabs" id="doc-tabs"></div>
                    <button class="doc-control-btn">
                        <span class="material-icons-outlined" style="font-size:18px">download</span>
                        Download
                    </button>
                </div>
                <div class="doc-body">
                    <div class="doc-page" id="doc-page-content"></div>
                </div>
            </div>

            <div class="details-panel">
                <div class="panel-header">
                    <div class="panel-tabs">
                        <button class="panel-tab active" data-tab="details" onclick="switchTab('details')">Details</button>
                        <button class="panel-tab" data-tab="event-log" onclick="switchTab('event-log')">Event Log</button>
                        <button class="panel-tab" data-tab="documents" onclick="switchTab('documents')">Documents</button>
                        <button class="panel-tab" data-tab="ask-ai" onclick="switchTab('ask-ai')">Ask AI</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="quick-actions" id="quick-actions"></div>

                    <div id="details-tab" class="tab-pane active"></div>
                    <div id="event-log-tab" class="tab-pane"></div>
                    <div id="documents-tab" class="tab-pane"></div>
                    <div id="ask-ai-tab" class="tab-pane"></div>
                </div>
                <div class="action-bar" id="action-bar"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="send-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="send-modal-title">Send Document</h2>
                <button class="modal-close" onclick="closeModal('send-modal')">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body" id="send-modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('send-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitSend()" id="send-modal-submit">Send</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="close-modal">
        <div class="modal" style="max-width:420px">
            <div class="modal-header">
                <h2 class="modal-title">Close Case</h2>
                <button class="modal-close" onclick="closeModal('close-modal')">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body" style="text-align:center">
                <div style="width:72px;height:72px;background:var(--success-light);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
                    <span class="material-icons-outlined" style="font-size:36px;color:var(--success)">check_circle</span>
                </div>
                <h3 style="margin-bottom:8px;font-size:18px">Close this case?</h3>
                <p style="color:var(--gray-600);font-size:14px">This marks the case as complete.</p>
            </div>
            <div class="modal-footer" style="justify-content:center">
                <button class="btn btn-secondary" onclick="closeModal('close-modal')">Cancel</button>
                <button class="btn btn-success" onclick="submitClose()">Yes, Close Case</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="upload-modal">
        <div class="modal" style="max-width:480px">
            <div class="modal-header">
                <h2 class="modal-title">Upload Document</h2>
                <button class="modal-close" onclick="closeModal('upload-modal')">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="border:2px dashed var(--gray-300);border-radius:var(--radius-lg);padding:40px;text-align:center;cursor:pointer" onclick="simulateFileSelect()">
                    <span class="material-icons-outlined" style="font-size:48px;color:var(--gray-400);display:block;margin-bottom:12px">cloud_upload</span>
                    <p style="color:var(--gray-600);font-weight:500">Click to select file</p>
                    <p style="color:var(--gray-400);font-size:12px;margin-top:4px">PDF, DOCX, XLSX up to 10MB</p>
                </div>
                <div class="form-group" style="margin-top:20px">
                    <label class="form-label">Document Name</label>
                    <input type="text" class="form-input" id="upload-name" placeholder="Enter document name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('upload-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitUpload()">Upload</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="doc-comment-modal">
        <div class="modal" style="max-width:480px">
            <div class="modal-header">
                <h2 class="modal-title">Add Comment</h2>
                <button class="modal-close" onclick="closeModal('doc-comment-modal')">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="doc-comment-context" style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--gray-50);border-radius:8px;margin-bottom:16px">
                    <span class="material-icons-outlined" style="color:var(--primary)">description</span>
                    <div>
                        <div style="font-size:12px;color:var(--gray-500)">Commenting on</div>
                        <div id="doc-comment-name" style="font-weight:600;color:var(--gray-900)">Document name</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Your Comment</label>
                    <textarea class="form-textarea" id="doc-comment-text" placeholder="Write your comment or observation about this document..." style="min-height:120px"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('doc-comment-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitDocComment()">Add Comment</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        
        const ROLES = {
            dto: { id: 'dto', name: 'Anil Kumar', shortName: 'Anil', title: 'Document Transfer Officer', initials: 'AK', color: '#059669' },
            ea: { id: 'ea', name: 'Priya Kumar', shortName: 'Priya', title: 'Executive Assistant', initials: 'PK', color: '#7c3aed' },
            cs: { id: 'cs', name: 'Raman Singh', shortName: 'Raman', title: 'Chief Secretary', initials: 'RS', color: '#2563eb' },
            ao: { id: 'ao', name: 'John Mekeo', shortName: 'John', title: 'Action Officer', initials: 'JM', color: '#dc2626' }
        };

        const TRANSITIONS = {
            'dto-ea': { title: 'Send to Executive Assistant', showRecipientSelect: false, recipient: 'ea', showActionSelect: false, implicitAction: 'triage', showPriority: true, showTasks: false, showDocSelect: false },
            'dto-cs': { title: 'Send to Chief Secretary (Urgent)', showRecipientSelect: false, recipient: 'cs', showActionSelect: false, implicitAction: 'urgent-review', showPriority: true, showTasks: false, showDocSelect: false },
            'ea-cs': { title: 'Forward to Chief Secretary', showRecipientSelect: false, recipient: 'cs', showActionSelect: true, actions: [
                { value: 'review', label: 'For Review', desc: 'Needs CS assessment' },
                { value: 'approve', label: 'For Approval', desc: 'Ready for CS decision' },
                { value: 'delegate', label: 'Recommend Delegation', desc: 'Suggest assigning to Action Officer' }
            ], showPriority: false, showTasks: false, showDocSelect: false },
            'cs-ao': { title: 'Delegate to Action Officer', showRecipientSelect: true, recipientOptions: ['ao'], showActionSelect: false, implicitAction: 'delegation', showPriority: false, showDueDate: true, showTasks: true, showDocSelect: false },
            'ao-cs': { title: 'Submit to Chief Secretary', showRecipientSelect: false, recipient: 'cs', showActionSelect: true, actions: [
                { value: 'review', label: 'Request Review', desc: 'Please review my work' },
                { value: 'approve', label: 'Request Approval', desc: 'Please approve this document' },
                { value: 'sign', label: 'Request Signature', desc: 'Please sign this document' }
            ], showPriority: false, showTasks: false, showDocSelect: true, showCompletedTasks: true },
            'cs-sendback': { title: 'Send Back', showRecipientSelect: true, recipientOptions: ['ea', 'dto', 'ao'], showActionSelect: false, implicitAction: 'revision', showPriority: false, showTasks: false, showDocSelect: false },
            'ea-sendback': { title: 'Return to DTO', showRecipientSelect: false, recipient: 'dto', showActionSelect: false, implicitAction: 'revision', showPriority: false, showTasks: false, showDocSelect: false },
            'cs-reject': { title: 'Reject Case', showRecipientSelect: false, recipient: 'dto', showActionSelect: false, implicitAction: 'rejected', showPriority: false, showTasks: false, showDocSelect: false }
        };

        // Role-specific configurations
        const ROLE_CONFIG = {
            dto: {
                taskView: 'hidden',      // Don't show tasks section
                pendingBannerStyle: 'standard',
                aiHint: 'Review document type and route appropriately.'
            },
            ea: {
                taskView: 'summary',     // Show minimal summary
                pendingBannerStyle: 'triage',
                aiHint: 'Assess priority and recommend action for Chief Secretary.'
            },
            cs: {
                taskView: 'progress',    // Show progress tracking
                pendingBannerStyle: 'decision',
                aiHint: 'Key decision: Approve K1.2B allocation across 4 departments.'
            },
            ao: {
                taskView: 'interactive', // Show checkboxes
                pendingBannerStyle: 'work',
                aiHint: 'Complete assigned tasks: review allocations, draft response.'
            }
        };

        // =============================================
        // STATE
        // =============================================
        
        function getInitialState() {
            return {
                currentRole: 'dto',
                selectedDocId: 'main',
                eventsExpanded: false,
                highlightLatestEvent: false,
                
                sectionStates: {
                    aiSummary: true,
                    actionItems: true,
                    comments: true,
                    documents: false
                },
                
                showAllComments: false,
                showAllTasks: false,
                
                currentTransition: null,
                modalTasks: [''],
                modalSelectedDocs: [],
                modalSelectedAction: null,
                modalLinkedDocument: null,
                
                // Track task assignment metadata
                taskAssignment: {
                    assignedBy: null,
                    assignedAt: null
                },
                
                caseInfo: {
                    id: 'DOC-2025-0847',
                    title: 'Budget Proposal 2025',
                    workflowType: 'budget',
                    priority: 'high',
                    status: 'active', // active, closed, rejected
                    currentHolder: 'dto',
                    previousHolder: null,
                    pendingAction: null,
                    pendingFrom: null,
                    dueDate: '2025-12-05', // ISO format for calculation
                    dueDateDisplay: 'Dec 5, 2025',
                    createdAt: 'Nov 22, 2025'
                },
                
                documents: [
                    {
                        id: 'main',
                        name: 'Budget_Proposal_2025.pdf',
                        type: 'pdf',
                        size: '3.8 MB',
                        uploadedBy: 'dto',
                        uploadedAt: 'Nov 22, 2025',
                        status: 'original',
                        submittedTo: null,
                        content: `
                            <h1>BUDGET PROPOSAL 2025</h1>
                            <p class="subtitle">Office of the Chief Secretary<br>Papua New Guinea<br>Document Reference: OCS/BUDGET/2025/001</p>
                            
                            <h2>1. Executive Summary</h2>
                            <p>This document presents the comprehensive budget proposal for the fiscal year 2025, outlining strategic allocations across key sectors to support Papua New Guinea's continued development and economic growth. The total proposed budget of <strong>K1.2 billion</strong> represents a 12% increase from the previous fiscal year, reflecting our commitment to expanding public services and infrastructure.</p>
                            <p>The budget has been developed in consultation with all relevant ministries, provincial administrations, and key stakeholders to ensure alignment with the National Development Strategy 2030 and the Medium Term Fiscal Strategy. Special emphasis has been placed on improving service delivery in rural areas and strengthening institutional capacity across government agencies.</p>
                            <p>Key highlights of this budget proposal include significant investments in digital infrastructure, healthcare modernization, and educational facilities across all 22 provinces. The proposal incorporates lessons learned from the 2024 fiscal year and addresses emerging priorities identified through extensive stakeholder consultations.</p>
                            
                            <h2>2. Budget Allocation Overview</h2>
                            <table>
                                <thead><tr><th>Department</th><th>Allocation (K)</th><th>% of Total</th><th>Change from 2024</th></tr></thead>
                                <tbody>
                                    <tr><td>Infrastructure Development</td><td>450,000,000</td><td>37.5%</td><td>+15%</td></tr>
                                    <tr><td>Healthcare Services</td><td>320,000,000</td><td>26.7%</td><td>+18%</td></tr>
                                    <tr><td>Education & Training</td><td>280,000,000</td><td>23.3%</td><td>+10%</td></tr>
                                    <tr><td>Administrative Operations</td><td>150,000,000</td><td>12.5%</td><td>+5%</td></tr>
                                    <tr style="font-weight:bold;background:#f3f4f6"><td>Total Budget</td><td>1,200,000,000</td><td>100%</td><td>+12%</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>3. Infrastructure Development (K450 Million)</h2>
                            <p>The Infrastructure Development allocation represents the largest share of the budget, reflecting the government's priority to improve connectivity and support economic development across all provinces. This investment is critical for achieving the connectivity targets set out in the PNG Vision 2050 framework.</p>
                            
                            <h3>3.1 Road Network Improvements</h3>
                            <p>A total of K180 million has been allocated for road network improvements, including:</p>
                            <ul>
                                <li>Rehabilitation of 450km of national highways connecting major economic centers</li>
                                <li>Construction of 12 new bridges in rural areas to improve market access</li>
                                <li>Sealing of 200km of provincial roads in priority corridors</li>
                                <li>Emergency road maintenance fund of K25 million for disaster response</li>
                                <li>Installation of road safety infrastructure including signage and barriers</li>
                            </ul>
                            <p>The road improvement program prioritizes routes that connect agricultural production areas to markets, supporting the government's economic diversification agenda. Environmental impact assessments have been completed for all major projects.</p>
                            
                            <h3>3.2 Public Buildings & Facilities</h3>
                            <p>K120 million has been allocated for the construction and renovation of public buildings:</p>
                            <ul>
                                <li>Construction of 5 new district administration offices in underserved areas</li>
                                <li>Renovation of 15 provincial government buildings to modern standards</li>
                                <li>Completion of the National Archives facility in Port Moresby</li>
                                <li>Upgrade of border crossing facilities at Wutung and Bensbach</li>
                                <li>Construction of 3 new police stations in high-priority districts</li>
                            </ul>
                            
                            <h3>3.3 Water & Sanitation</h3>
                            <p>K85 million for water and sanitation infrastructure:</p>
                            <ul>
                                <li>Urban water supply expansion in 8 provincial capitals</li>
                                <li>Rural water supply systems for 200 communities</li>
                                <li>Sewerage system upgrades in Port Moresby and Lae</li>
                                <li>Water quality monitoring equipment for all provincial water authorities</li>
                                <li>Community water management training programs</li>
                            </ul>
                            
                            <h3>3.4 Digital Infrastructure</h3>
                            <p>K65 million for digital connectivity improvements:</p>
                            <ul>
                                <li>Fiber optic cable extension to 5 additional provinces</li>
                                <li>Mobile network coverage expansion to remote communities</li>
                                <li>E-government platform development and rollout</li>
                                <li>Digital literacy centers in district capitals</li>
                                <li>Government data center modernization</li>
                            </ul>
                            
                            <h2>4. Healthcare Services (K320 Million)</h2>
                            <p>The healthcare allocation reflects our commitment to improving health outcomes and expanding access to quality medical services throughout Papua New Guinea. This investment supports the National Health Plan 2021-2030 objectives.</p>
                            
                            <h3>4.1 Hospital Infrastructure</h3>
                            <p>K140 million for hospital development:</p>
                            <ul>
                                <li>Construction of 3 new regional hospitals in Western, Gulf, and Sandaun provinces</li>
                                <li>Expansion of Port Moresby General Hospital emergency department</li>
                                <li>Upgrade of medical equipment in 20 district hospitals</li>
                                <li>Construction of staff housing at remote health facilities</li>
                                <li>Installation of solar power systems at 30 rural health facilities</li>
                            </ul>
                            
                            <h3>4.2 Primary Healthcare</h3>
                            <p>K95 million for primary healthcare services:</p>
                            <ul>
                                <li>Establishment of 50 new aid posts in underserved areas</li>
                                <li>Mobile health clinic program expansion to cover 150 additional communities</li>
                                <li>Maternal and child health program enhancement</li>
                                <li>Immunization program coverage expansion to achieve 95% target</li>
                                <li>Community health volunteer training and support</li>
                            </ul>
                            
                            <h3>4.3 Medical Supplies & Pharmaceuticals</h3>
                            <p>K55 million for essential medicines and supplies:</p>
                            <ul>
                                <li>Procurement of essential medicines for all health facilities</li>
                                <li>Medical supply chain improvement program</li>
                                <li>Cold chain infrastructure for vaccine storage</li>
                                <li>Diagnostic equipment for district hospitals</li>
                            </ul>
                            
                            <h3>4.4 Health Workforce Development</h3>
                            <p>K30 million for healthcare workforce:</p>
                            <ul>
                                <li>Training of 200 community health workers</li>
                                <li>Specialist training scholarships for 50 doctors</li>
                                <li>Nursing school expansion program</li>
                                <li>Continuing professional development for existing staff</li>
                            </ul>
                            
                            <h2>5. Education & Training (K280 Million)</h2>
                            <p>Investment in education remains a key priority to develop human capital and support long-term economic growth. This allocation supports the National Education Plan 2020-2029.</p>
                            
                            <h3>5.1 School Infrastructure</h3>
                            <p>K120 million for school construction and renovation:</p>
                            <ul>
                                <li>Construction of 80 new elementary school classrooms</li>
                                <li>Renovation of 150 existing school buildings</li>
                                <li>Construction of 20 new secondary school science laboratories</li>
                                <li>Teacher housing construction in remote areas</li>
                                <li>School water and sanitation facilities upgrade</li>
                            </ul>
                            
                            <h3>5.2 Technical & Vocational Training</h3>
                            <p>K75 million for TVET programs:</p>
                            <ul>
                                <li>Establishment of 3 new vocational training centers</li>
                                <li>Equipment upgrade for existing technical colleges</li>
                                <li>Industry partnership programs for apprenticeships</li>
                                <li>Skills certification program development</li>
                                <li>Youth employment readiness programs</li>
                            </ul>
                            
                            <h3>5.3 Tertiary Education Support</h3>
                            <p>K50 million for higher education:</p>
                            <ul>
                                <li>University of Papua New Guinea infrastructure upgrade</li>
                                <li>Research grants for locally-focused studies</li>
                                <li>Student scholarship program expansion</li>
                                <li>Academic staff development programs</li>
                            </ul>
                            
                            <h3>5.4 Education Quality Programs</h3>
                            <p>K35 million for quality improvement:</p>
                            <ul>
                                <li>Curriculum development and textbook production</li>
                                <li>Teacher professional development programs</li>
                                <li>Digital learning resources development</li>
                                <li>Education assessment and monitoring systems</li>
                            </ul>
                            
                            <h2>6. Administrative Operations (K150 Million)</h2>
                            <p>Operational funding ensures effective delivery of government services and maintains institutional capacity across all government agencies.</p>
                            
                            <h3>6.1 Personnel & Staffing</h3>
                            <p>K80 million for human resources:</p>
                            <ul>
                                <li>Staff salaries and allowances for approved positions</li>
                                <li>Recruitment of critical positions identified in workforce plans</li>
                                <li>Staff training and capacity building programs</li>
                                <li>Performance management system implementation</li>
                            </ul>
                            
                            <h3>6.2 Goods & Services</h3>
                            <p>K45 million for operational expenses:</p>
                            <ul>
                                <li>Office supplies and equipment procurement</li>
                                <li>Utilities and communications services</li>
                                <li>Vehicle fleet maintenance and fuel</li>
                                <li>Building maintenance and security services</li>
                            </ul>
                            
                            <h3>6.3 ICT & Systems</h3>
                            <p>K25 million for technology systems:</p>
                            <ul>
                                <li>Government network infrastructure upgrade</li>
                                <li>Financial management system enhancement</li>
                                <li>Human resource information system</li>
                                <li>Cybersecurity improvements and monitoring</li>
                            </ul>
                            
                            <h2>7. Provincial Allocation Breakdown</h2>
                            <p>Budget allocations by region ensure equitable distribution of resources:</p>
                            <table>
                                <thead><tr><th>Region</th><th>Provinces</th><th>Allocation (K)</th><th>% of Total</th></tr></thead>
                                <tbody>
                                    <tr><td>Southern Region</td><td>Central, NCD, Gulf, Western, Milne Bay</td><td>340,000,000</td><td>28.3%</td></tr>
                                    <tr><td>Highlands Region</td><td>Eastern Highlands, Western Highlands, Southern Highlands, Enga, Simbu, Jiwaka, Hela</td><td>380,000,000</td><td>31.7%</td></tr>
                                    <tr><td>Momase Region</td><td>Morobe, Madang, East Sepik, West Sepik</td><td>280,000,000</td><td>23.3%</td></tr>
                                    <tr><td>Islands Region</td><td>East New Britain, West New Britain, New Ireland, Manus, Bougainville</td><td>200,000,000</td><td>16.7%</td></tr>
                                    <tr style="font-weight:bold;background:#f3f4f6"><td colspan="2">Total</td><td>1,200,000,000</td><td>100%</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>8. Implementation Timeline</h2>
                            <p>The budget implementation follows a phased approach:</p>
                            <table>
                                <thead><tr><th>Phase</th><th>Period</th><th>Key Activities</th><th>Budget Release</th></tr></thead>
                                <tbody>
                                    <tr><td>Phase 1</td><td>Jan - Mar 2025</td><td>Procurement planning, tender preparation, staff recruitment</td><td>25%</td></tr>
                                    <tr><td>Phase 2</td><td>Apr - Jun 2025</td><td>Major contracts awarded, construction begins, equipment procurement</td><td>30%</td></tr>
                                    <tr><td>Phase 3</td><td>Jul - Sep 2025</td><td>Construction progress, program implementation, mid-year review</td><td>25%</td></tr>
                                    <tr><td>Phase 4</td><td>Oct - Dec 2025</td><td>Project completion, final payments, evaluation</td><td>20%</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>9. Risk Assessment & Mitigation</h2>
                            <p>The following risks have been identified and mitigation strategies developed:</p>
                            <table>
                                <thead><tr><th>Risk Category</th><th>Description</th><th>Mitigation Strategy</th></tr></thead>
                                <tbody>
                                    <tr><td>Economic</td><td>Currency fluctuation affecting import costs</td><td>Contingency fund of K30 million; forward contracts for major procurements</td></tr>
                                    <tr><td>Implementation</td><td>Contractor capacity constraints</td><td>Early procurement; capacity building programs; international partnerships</td></tr>
                                    <tr><td>Geographic</td><td>Access challenges to remote areas</td><td>Wet season planning; alternative delivery methods; local contractor engagement</td></tr>
                                    <tr><td>Governance</td><td>Procurement delays</td><td>Streamlined approval processes; advance procurement planning</td></tr>
                                    <tr><td>Climate</td><td>Natural disasters impacting projects</td><td>Emergency reserve fund; climate-resilient design standards</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>10. Monitoring & Evaluation Framework</h2>
                            <p>A comprehensive M&E framework will track budget implementation:</p>
                            <ul>
                                <li><strong>Quarterly Reviews:</strong> Progress reports to Cabinet with variance analysis</li>
                                <li><strong>Mid-Year Assessment:</strong> Comprehensive review with reallocation recommendations</li>
                                <li><strong>Annual Audit:</strong> Full financial and performance audit by Auditor General</li>
                                <li><strong>Key Performance Indicators:</strong> Sector-specific metrics aligned with national targets</li>
                                <li><strong>Public Reporting:</strong> Quarterly budget execution reports published online</li>
                            </ul>
                            
                            <h3>10.1 Key Performance Indicators</h3>
                            <table>
                                <thead><tr><th>Sector</th><th>Indicator</th><th>Baseline (2024)</th><th>Target (2025)</th></tr></thead>
                                <tbody>
                                    <tr><td>Infrastructure</td><td>Km of sealed roads</td><td>8,500</td><td>9,150</td></tr>
                                    <tr><td>Healthcare</td><td>Health facility coverage</td><td>78%</td><td>85%</td></tr>
                                    <tr><td>Education</td><td>Primary enrollment rate</td><td>85%</td><td>90%</td></tr>
                                    <tr><td>Administration</td><td>Service delivery satisfaction</td><td>62%</td><td>75%</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>11. Stakeholder Consultation Summary</h2>
                            <p>This budget proposal incorporates feedback from extensive consultations conducted between August and October 2024:</p>
                            <ul>
                                <li>22 provincial administration consultations with governors and administrators</li>
                                <li>15 sector ministry workshops with department heads and technical staff</li>
                                <li>Civil society organization forums in 4 regional centers</li>
                                <li>Private sector roundtables with Chamber of Commerce representatives</li>
                                <li>Development partner coordination meetings with donor agencies</li>
                                <li>Community focus groups in selected districts</li>
                            </ul>
                            
                            <h3>11.1 Key Feedback Incorporated</h3>
                            <ul>
                                <li>Increased allocation for rural water supply following provincial requests</li>
                                <li>Enhanced focus on teacher housing in remote areas based on education sector feedback</li>
                                <li>Addition of cybersecurity component following IT department recommendations</li>
                                <li>Inclusion of climate-resilient infrastructure standards per civil society input</li>
                            </ul>
                            
                            <h2>12. Budget Sustainability Analysis</h2>
                            <p>The proposed budget has been assessed for long-term fiscal sustainability:</p>
                            
                            <h3>12.1 Revenue Projections</h3>
                            <table>
                                <thead><tr><th>Revenue Source</th><th>2024 Actual (K)</th><th>2025 Projected (K)</th><th>Change</th></tr></thead>
                                <tbody>
                                    <tr><td>Tax Revenue</td><td>650,000,000</td><td>720,000,000</td><td>+10.8%</td></tr>
                                    <tr><td>Resource Revenue</td><td>280,000,000</td><td>310,000,000</td><td>+10.7%</td></tr>
                                    <tr><td>Grants & Aid</td><td>120,000,000</td><td>130,000,000</td><td>+8.3%</td></tr>
                                    <tr><td>Other Revenue</td><td>50,000,000</td><td>55,000,000</td><td>+10.0%</td></tr>
                                    <tr style="font-weight:bold;background:#f3f4f6"><td>Total Revenue</td><td>1,100,000,000</td><td>1,215,000,000</td><td>+10.5%</td></tr>
                                </tbody>
                            </table>
                            
                            <h3>12.2 Fiscal Balance</h3>
                            <p>The budget maintains a sustainable fiscal position with a small surplus projected for 2025:</p>
                            <ul>
                                <li>Projected Revenue: K1,215,000,000</li>
                                <li>Proposed Expenditure: K1,200,000,000</li>
                                <li>Fiscal Balance: K15,000,000 (surplus)</li>
                                <li>Debt Service Ratio: 12% of revenue (within sustainable limits)</li>
                            </ul>
                            
                            <h2>13. Recommendation</h2>
                            <p style="background:#f0fdf4;padding:20px;border-radius:8px;border-left:4px solid #16a34a">
                                <strong>RECOMMENDATION:</strong><br><br>
                                Based on the comprehensive analysis and alignment with national development priorities, it is recommended that this Budget Proposal for Fiscal Year 2025, totaling K1.2 billion, be approved for Cabinet consideration and subsequent submission to Parliament.<br><br>
                                The proposed allocations reflect careful prioritization of national needs while maintaining fiscal responsibility and sustainability. The budget supports the achievement of key development targets and addresses critical infrastructure and service delivery gaps identified through extensive consultation processes.
                            </p>
                            
                            <h2>Appendix A: Detailed Budget Line Items</h2>
                            <table>
                                <thead><tr><th>Line Item</th><th>Description</th><th>Amount (K)</th></tr></thead>
                                <tbody>
                                    <tr><td>3.1.1</td><td>Highway rehabilitation - Highlands Highway</td><td>45,000,000</td></tr>
                                    <tr><td>3.1.2</td><td>Highway rehabilitation - Sepik Highway</td><td>35,000,000</td></tr>
                                    <tr><td>3.1.3</td><td>Bridge construction program</td><td>28,000,000</td></tr>
                                    <tr><td>3.1.4</td><td>Provincial road sealing</td><td>47,000,000</td></tr>
                                    <tr><td>3.1.5</td><td>Emergency road maintenance</td><td>25,000,000</td></tr>
                                    <tr><td>3.2.1</td><td>District administration offices</td><td>45,000,000</td></tr>
                                    <tr><td>3.2.2</td><td>Provincial building renovations</td><td>38,000,000</td></tr>
                                    <tr><td>3.2.3</td><td>National Archives facility</td><td>22,000,000</td></tr>
                                    <tr><td>3.2.4</td><td>Border facilities upgrade</td><td>15,000,000</td></tr>
                                    <tr><td>3.3.1</td><td>Urban water supply</td><td>42,000,000</td></tr>
                                    <tr><td>3.3.2</td><td>Rural water systems</td><td>28,000,000</td></tr>
                                    <tr><td>3.3.3</td><td>Sewerage upgrades</td><td>15,000,000</td></tr>
                                    <tr><td>3.4.1</td><td>Fiber optic extension</td><td>35,000,000</td></tr>
                                    <tr><td>3.4.2</td><td>Mobile network expansion</td><td>18,000,000</td></tr>
                                    <tr><td>3.4.3</td><td>E-government platform</td><td>12,000,000</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>Appendix B: Provincial Allocation Details</h2>
                            <table>
                                <thead><tr><th>Province</th><th>Infrastructure</th><th>Healthcare</th><th>Education</th><th>Total (K)</th></tr></thead>
                                <tbody>
                                    <tr><td>National Capital District</td><td>25,000,000</td><td>18,000,000</td><td>12,000,000</td><td>55,000,000</td></tr>
                                    <tr><td>Central</td><td>22,000,000</td><td>15,000,000</td><td>13,000,000</td><td>50,000,000</td></tr>
                                    <tr><td>Morobe</td><td>28,000,000</td><td>20,000,000</td><td>17,000,000</td><td>65,000,000</td></tr>
                                    <tr><td>Eastern Highlands</td><td>24,000,000</td><td>17,000,000</td><td>14,000,000</td><td>55,000,000</td></tr>
                                    <tr><td>Western Highlands</td><td>23,000,000</td><td>16,000,000</td><td>13,000,000</td><td>52,000,000</td></tr>
                                    <tr><td>Southern Highlands</td><td>22,000,000</td><td>15,000,000</td><td>12,000,000</td><td>49,000,000</td></tr>
                                    <tr><td>East Sepik</td><td>20,000,000</td><td>14,000,000</td><td>11,000,000</td><td>45,000,000</td></tr>
                                    <tr><td>Madang</td><td>21,000,000</td><td>15,000,000</td><td>12,000,000</td><td>48,000,000</td></tr>
                                    <tr><td>East New Britain</td><td>19,000,000</td><td>13,000,000</td><td>10,000,000</td><td>42,000,000</td></tr>
                                    <tr><td>Other Provinces</td><td>246,000,000</td><td>177,000,000</td><td>166,000,000</td><td>589,000,000</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>Appendix C: Implementation Schedule</h2>
                            <table>
                                <thead><tr><th>Project</th><th>Q1 2025</th><th>Q2 2025</th><th>Q3 2025</th><th>Q4 2025</th></tr></thead>
                                <tbody>
                                    <tr><td>Highlands Highway Rehabilitation</td><td>Planning</td><td>Construction</td><td>Construction</td><td>Completion</td></tr>
                                    <tr><td>Regional Hospital Construction</td><td>Tender</td><td>Foundation</td><td>Construction</td><td>Construction</td></tr>
                                    <tr><td>School Building Program</td><td>Site Prep</td><td>Construction</td><td>Construction</td><td>Handover</td></tr>
                                    <tr><td>Water Supply Expansion</td><td>Design</td><td>Procurement</td><td>Installation</td><td>Commissioning</td></tr>
                                    <tr><td>Fiber Optic Extension</td><td>Survey</td><td>Installation</td><td>Testing</td><td>Go-Live</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>Appendix D: Stakeholder Consultation Log</h2>
                            <table>
                                <thead><tr><th>Date</th><th>Stakeholder Group</th><th>Location</th><th>Key Issues Raised</th></tr></thead>
                                <tbody>
                                    <tr><td>Aug 5, 2024</td><td>Provincial Governors Forum</td><td>Port Moresby</td><td>Rural infrastructure priorities</td></tr>
                                    <tr><td>Aug 12, 2024</td><td>Health Sector Working Group</td><td>Port Moresby</td><td>Medical supply chain issues</td></tr>
                                    <tr><td>Aug 19, 2024</td><td>Education Department</td><td>Port Moresby</td><td>Teacher housing shortage</td></tr>
                                    <tr><td>Aug 26, 2024</td><td>Chamber of Commerce</td><td>Lae</td><td>Infrastructure for economic growth</td></tr>
                                    <tr><td>Sep 2, 2024</td><td>Civil Society Forum</td><td>Mt Hagen</td><td>Climate resilience in projects</td></tr>
                                    <tr><td>Sep 9, 2024</td><td>Development Partners</td><td>Port Moresby</td><td>Aid coordination and alignment</td></tr>
                                    <tr><td>Sep 16, 2024</td><td>Highlands Region Administrators</td><td>Goroka</td><td>Road maintenance priorities</td></tr>
                                    <tr><td>Sep 23, 2024</td><td>Islands Region Administrators</td><td>Kokopo</td><td>Maritime infrastructure needs</td></tr>
                                </tbody>
                            </table>
                            
                            <h2>Appendix E: Risk Register</h2>
                            <table>
                                <thead><tr><th>Risk ID</th><th>Risk Description</th><th>Likelihood</th><th>Impact</th><th>Mitigation Owner</th></tr></thead>
                                <tbody>
                                    <tr><td>R001</td><td>Currency depreciation</td><td>Medium</td><td>High</td><td>Treasury</td></tr>
                                    <tr><td>R002</td><td>Contractor default</td><td>Low</td><td>High</td><td>Procurement</td></tr>
                                    <tr><td>R003</td><td>Natural disaster</td><td>Medium</td><td>High</td><td>NDMO</td></tr>
                                    <tr><td>R004</td><td>Cost overrun</td><td>Medium</td><td>Medium</td><td>Finance</td></tr>
                                    <tr><td>R005</td><td>Procurement delays</td><td>High</td><td>Medium</td><td>Central Supply</td></tr>
                                    <tr><td>R006</td><td>Skill shortage</td><td>Medium</td><td>Medium</td><td>HR Division</td></tr>
                                    <tr><td>R007</td><td>Political changes</td><td>Low</td><td>High</td><td>Cabinet Office</td></tr>
                                    <tr><td>R008</td><td>Revenue shortfall</td><td>Low</td><td>High</td><td>Treasury</td></tr>
                                </tbody>
                            </table>
                            
                            <div style="margin-top:60px;padding-top:20px;border-top:2px solid #e5e7eb">
                                <p style="text-align:center;color:#6b7280">
                                    <strong>Document Reference:</strong> OCS/BUDGET/2025/001<br>
                                    <strong>Classification:</strong> Official - Sensitive<br>
                                    <strong>Prepared by:</strong> Budget & Planning Division<br>
                                    <strong>Reviewed by:</strong> Office of the Chief Secretary<br>
                                    <strong>Date:</strong> November 2025<br>
                                    <strong>Version:</strong> 1.0 Final
                                </p>
                            </div>
                            
                            <div style="margin-top:40px;padding:20px;background:#f8fafc;border-radius:8px;text-align:center">
                                <p style="color:#64748b;font-size:12px;margin:0">
                                     End of Document <br>
                                    Total Pages: 12 | Word Count: Approximately 4,500
                                </p>
                            </div>
                        `,
                        viewedBy: ['dto'] // Only DTO has seen it initially
                    }
                ],
                
                // Submitted documents (for workflow tracking)
                // Starts empty - populated when AO submits to CS
                submissions: [],
                
                // Draft documents (not yet submitted)
                // Starts empty - populated when AO uploads
                drafts: [],
                
                comments: [], // Each comment: { id, author, text, timestamp, linkedDocId: null }
                actionItems: [], // Each task: { id, title, completed }
                
                events: [
                    { 
                        id: 1, 
                        type: 'created', 
                        actor: 'dto', 
                        note: 'Urgent submission from PM\'s office regarding FY2025 budget allocation.', 
                        timestamp: 'Nov 22, 2025' 
                    }
                ]
            };
        }

        let state = getInitialState();

        // =============================================
        // INITIALIZATION
        // =============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
            renderAskAITab();
            
            document.addEventListener('keydown', e => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
                }
            });

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', e => {
                    if (e.target === overlay) overlay.classList.remove('active');
                });
            });
        });

        function renderAll() {
            renderRoles();
            renderQueue();
            renderQuickActions();
            renderDocTabs();
            renderDocContent();
            renderDetailsTab();
            renderEventLog();
            renderDocumentsTab();
            renderActionBar();
        }

        // Quick Actions - Only show to current holder
        function renderQuickActions() {
            const container = document.getElementById('quick-actions');
            const isHolder = state.caseInfo.currentHolder === state.currentRole;
            const isClosed = state.caseInfo.status === 'closed';
            
            if (!isHolder || isClosed) {
                // Non-holders see observation mode indicator
                container.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--gray-50);border-radius:var(--radius-md);color:var(--gray-500);font-size:12px">
                        <span class="material-icons-outlined" style="font-size:16px">visibility</span>
                        Viewing mode  Actions available when assigned to you
                    </div>
                `;
                return;
            }
            
            // Current holder - no global buttons needed
            // Upload is in Documents section, comments in Send modal
            container.innerHTML = '';
        }

        function resetDemo() {
            state = getInitialState();
            renderAll();
            renderAskAITab();
            showToast('Demo reset successfully!', 'success');
        }

        // =============================================
        // ROLES
        // =============================================
        
        function renderRoles() {
            const container = document.getElementById('role-selector');
            container.innerHTML = Object.values(ROLES).map(role => {
                const isActive = state.currentRole === role.id;
                const hasCase = state.caseInfo.currentHolder === role.id && state.caseInfo.status === 'active';
                return `
                    <div class="role-avatar-btn tooltip ${isActive ? 'active' : ''}" 
                         style="background:${role.color}" 
                         onclick="switchRole('${role.id}')"
                         data-tooltip="${role.name}">
                        ${role.initials}
                        ${hasCase ? '<span class="role-badge">1</span>' : ''}
                    </div>
                `;
            }).join('');

            const currentRole = ROLES[state.currentRole];
            document.getElementById('current-role-info').innerHTML = `
                <div class="current-role-avatar" style="background:${currentRole.color}">${currentRole.initials}</div>
                <div>
                    <div class="current-role-name">${currentRole.name}</div>
                    <div class="current-role-title">${currentRole.title}</div>
                </div>
            `;
        }

        function switchRole(roleId) {
            const previousRole = state.currentRole;
            state.currentRole = roleId;
            state.highlightLatestEvent = false;
            
            // Add "viewed" event when switching to holder role (read receipt)
            if (state.caseInfo.currentHolder === roleId && state.caseInfo.status === 'active') {
                // Check if last event is already a "viewed" by same person
                const lastEvent = state.events[0];
                if (!(lastEvent && lastEvent.type === 'viewed' && lastEvent.actor === roleId)) {
                    state.events.unshift({
                        id: Date.now(),
                        type: 'viewed',
                        actor: roleId,
                        timestamp: 'Just now'
                    });
                }
            }
            
            renderAll();
            showToast(`Viewing as ${ROLES[roleId].name}`, 'success');
        }

        // =============================================
        // QUEUE
        // =============================================
        
        function renderQueue() {
            const container = document.getElementById('document-queue');
            const isHolder = state.caseInfo.currentHolder === state.currentRole;
            const isClosed = state.caseInfo.status === 'closed';
            
            if (!isHolder || isClosed) {
                container.innerHTML = `<div class="queue-empty"><div class="queue-empty-icon"></div><p>${isClosed ? 'Case closed' : 'No cases in queue'}</p></div>`;
                return;
            }
            
            const from = state.caseInfo.previousHolder ? ROLES[state.caseInfo.previousHolder].name : 'System';
            
            container.innerHTML = `
                <div class="queue-item active">
                    <div class="queue-priority ${state.caseInfo.priority}"></div>
                    <div class="queue-content">
                        <div class="queue-doc-title">${state.caseInfo.title}</div>
                        <div class="queue-doc-meta">${state.caseInfo.id}  From: ${from}</div>
                        <div class="queue-status">
                            <span class="material-icons-outlined" style="font-size:12px">schedule</span>
                            Due ${state.caseInfo.dueDate}
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // DOCUMENT VIEWER
        // =============================================
        
        function renderDocTabs() {
            const container = document.getElementById('doc-tabs');
            const visibleDocs = getVisibleDocuments();
            container.innerHTML = visibleDocs.map(doc => `
                <button class="doc-tab ${doc.id === state.selectedDocId ? 'active' : ''}" onclick="selectDoc('${doc.id}')">
                    ${doc.name.length > 25 ? doc.name.substring(0, 22) + '...' : doc.name}
                </button>
            `).join('');
        }

        function selectDoc(docId) {
            state.selectedDocId = docId;
            renderDocTabs();
            renderDocContent();
            renderDetailsTab();
            renderDocumentsTab();
        }
        
        // Called from Event Log - switches to Documents tab and selects doc
        function viewDocFromEventLog(docId) {
            state.selectedDocId = docId;
            switchTab('documents');
            renderDocTabs();
            renderDocContent();
        }
        
        // Find a document from any source (documents, drafts, submissions)
        function findDocument(docId) {
            // Check main documents
            let doc = state.documents.find(d => d.id === docId);
            if (doc) return doc;
            
            // Check drafts
            doc = state.drafts.find(d => d.id === docId);
            if (doc) return doc;
            
            // Check submissions
            for (const sub of state.submissions) {
                doc = sub.documents.find(d => d.id === docId);
                if (doc) return doc;
            }
            
            return null;
        }

        function renderDocContent() {
            const container = document.getElementById('doc-page-content');
            const doc = findDocument(state.selectedDocId);
            
            if (doc && doc.content) {
                container.innerHTML = doc.content;
            } else if (doc) {
                // Better fallback for documents without content
                const docTypeIcons = { pdf: '', excel: '', word: '' };
                const uploader = ROLES[doc.uploadedBy];
                container.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:60px">
                        <div style="font-size:72px;margin-bottom:24px">${docTypeIcons[doc.type] || ''}</div>
                        <h2 style="font-size:24px;font-weight:600;color:var(--gray-900);margin-bottom:8px">${doc.name}</h2>
                        <p style="color:var(--gray-500);margin-bottom:24px">${doc.size}  Uploaded by ${uploader.name}</p>
                        <div style="background:var(--gray-100);border-radius:12px;padding:24px 32px;max-width:400px">
                            <p style="color:var(--gray-600);font-size:14px">
                                This document is available for download. Click the download button above to view the full content.
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // Get all documents visible to current role
        function getVisibleDocuments() {
            const role = state.currentRole;
            let docs = [];
            
            // Original document is always visible
            const originals = state.documents.filter(d => d.status === 'original');
            docs.push(...originals);
            
            // Add drafts (only visible to owner)
            const myDrafts = state.drafts.filter(d => d.uploadedBy === role);
            docs.push(...myDrafts);
            
            // Add submitted documents based on role visibility
            state.submissions.forEach(sub => {
                const canSee = sub.submittedBy === role || 
                               sub.submittedTo === role || 
                               role === 'ea'; // EA can see all for awareness
                if (canSee) {
                    sub.documents.forEach(doc => {
                        if (!docs.find(d => d.id === doc.id)) {
                            docs.push({ ...doc, submissionId: sub.id, submissionStatus: sub.status });
                        }
                    });
                }
            });
            
            return docs;
        }

        // Get current role's draft documents (for send modal)
        function getMyDraftDocuments() {
            return state.drafts.filter(d => d.uploadedBy === state.currentRole);
        }
        
        // Get all documents available for selection in send modal
        function getSelectableDocuments() {
            const role = state.currentRole;
            
            if (role === 'ao') {
                // AO can only select their drafts to send
                return state.drafts.filter(d => d.uploadedBy === 'ao');
            } else if (role === 'dto' || role === 'ea') {
                // DTO/EA can forward original documents
                return state.documents.filter(d => d.status === 'original');
            }
            
            return [];
        }

        // =============================================
        // DETAILS TAB - ROLE-BASED RENDERING
        // =============================================
        
        function renderDetailsTab() {
            const container = document.getElementById('details-tab');
            const holder = ROLES[state.caseInfo.currentHolder];
            const isMe = state.caseInfo.currentHolder === state.currentRole;
            const isClosed = state.caseInfo.status === 'closed';
            const roleConfig = ROLE_CONFIG[state.currentRole];
            
            let html = '';
            
            // Viewing mode indicator for non-holders
            if (!isMe && !isClosed) {
                html += `
                    <div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:linear-gradient(135deg,var(--gray-100) 0%,var(--gray-50) 100%);border:1px dashed var(--gray-300);border-radius:var(--radius-md);margin-bottom:12px;font-size:12px;color:var(--gray-600)">
                        <span class="material-icons-outlined" style="font-size:16px;color:var(--gray-400)">visibility</span>
                        <span>Viewing as <strong>${ROLES[state.currentRole].title}</strong>  Case is with ${holder.name}</span>
                    </div>
                `;
            }
            
            //  PENDING ACTION BANNER - Role-specific
            if (isClosed) {
                html += `
                    <div class="banner-closed">
                        <span class="material-icons-outlined">verified</span>
                        <h3>Case Closed</h3>
                        <p>This case has been completed.</p>
                    </div>
                `;
            } else if (state.caseInfo.pendingAction && isMe) {
                html += renderPendingBanner();
            }
            
            //  CURRENTLY WITH
            html += `
                <div class="current-holder" onclick="goToEventLog()">
                    <div class="holder-avatar" style="background:${holder.color}">${holder.initials}</div>
                    <div style="flex:1">
                        <div class="holder-label">Currently With</div>
                        <div class="holder-name">${holder.name}</div>
                        <div class="holder-role">${holder.title}</div>
                    </div>
                    ${isMe && !isClosed ? '<span class="holder-you-badge">YOU</span>' : ''}
                    <span class="holder-hint">
                        <span class="material-icons-outlined" style="font-size:14px">history</span>
                        View history
                    </span>
                </div>
            `;
            
            //  STATUS CARD with deadline warnings
            const daysRemaining = getDaysRemaining(state.caseInfo.dueDate);
            const deadlineClass = daysRemaining <= 1 ? 'danger' : daysRemaining <= 3 ? 'warning' : '';
            const canChangePriority = state.currentRole === 'cs' && isMe && !isClosed;
            
            html += `
                <div class="status-card">
                    <div class="status-row">
                        <span class="status-label">Priority</span>
                        ${canChangePriority ? `
                            <div class="priority-dropdown" onclick="togglePriorityDropdown(event)">
                                <span class="priority-badge ${state.caseInfo.priority}">
                                    <span class="priority-dot"></span>
                                    ${state.caseInfo.priority.charAt(0).toUpperCase() + state.caseInfo.priority.slice(1)}
                                    <span class="material-icons-outlined" style="font-size:14px;margin-left:4px">expand_more</span>
                                </span>
                                <div class="priority-options" id="priority-options">
                                    <div class="priority-option ${state.caseInfo.priority === 'high' ? 'active' : ''}" onclick="changePriority('high')">
                                        <span class="priority-badge high"><span class="priority-dot"></span>High</span>
                                    </div>
                                    <div class="priority-option ${state.caseInfo.priority === 'medium' ? 'active' : ''}" onclick="changePriority('medium')">
                                        <span class="priority-badge medium"><span class="priority-dot"></span>Medium</span>
                                    </div>
                                    <div class="priority-option ${state.caseInfo.priority === 'low' ? 'active' : ''}" onclick="changePriority('low')">
                                        <span class="priority-badge low"><span class="priority-dot"></span>Low</span>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <span class="priority-badge ${state.caseInfo.priority}">
                                <span class="priority-dot"></span>
                                ${state.caseInfo.priority.charAt(0).toUpperCase() + state.caseInfo.priority.slice(1)}
                            </span>
                        `}
                    </div>
                    <div class="status-row">
                        <span class="status-label">Due Date</span>
                        <span class="status-value ${deadlineClass ? 'deadline-' + deadlineClass : ''}">
                            ${state.caseInfo.dueDateDisplay}
                            ${deadlineClass === 'danger' ? '<span class="deadline-warning"> Due Today!</span>' : ''}
                            ${deadlineClass === 'warning' ? '<span class="deadline-warning warning"> ' + daysRemaining + ' days left</span>' : ''}
                        </span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Created</span>
                        <span class="status-value">${state.caseInfo.createdAt}</span>
                    </div>
                </div>
            `;
            
            //  AI SUMMARY - Role-specific hint
            html += renderAISummary();
            
            //  COMMENTS (moved before tasks)
            html += renderCommentsSection();
            
            //  ACTION ITEMS - Role-based view (now after comments)
            html += renderActionItemsSection();
            
            //  DOCUMENTS
            html += renderDocumentsSection();
            
            container.innerHTML = html;
        }

        // Role-specific Pending Banner
        function renderPendingBanner() {
            const requester = ROLES[state.caseInfo.pendingFrom];
            const role = state.currentRole;
            
            // AO gets special "Work Assigned" banner - only show if there are incomplete tasks
            if (role === 'ao' && state.caseInfo.pendingAction === 'delegation') {
                const taskCount = state.actionItems.length;
                const incomplete = state.actionItems.filter(t => !t.completed).length;
                
                // Don't show banner if no tasks or all complete
                if (taskCount === 0 || incomplete === 0) {
                    return ''; // No banner needed
                }
                
                return `
                    <div class="banner-work-assigned">
                        <div class="banner-icon">
                            <span class="material-icons-outlined">assignment</span>
                        </div>
                        <div>
                            <div class="banner-pending-title">Work Assigned to You</div>
                            <div class="banner-pending-subtitle">${incomplete} of ${taskCount} tasks remaining  From ${requester.name}</div>
                        </div>
                    </div>
                `;
            }
            
            // Standard pending banner for others
            const actionLabels = {
                'review': 'Review Requested',
                'approve': 'Approval Requested',
                'sign': 'Signature Requested',
                'delegate': 'Delegation Recommended',
                'triage': 'Triage Required',
                'urgent-review': 'Urgent Review Needed',
                'delegation': 'Tasks Delegated',
                'revision': 'Revision Requested'
            };
            
            // Role-specific subtitles
            const subtitles = {
                dto: 'Route to appropriate recipient',
                ea: 'Review and forward to Chief Secretary',
                cs: 'Review and take action',
                ao: 'Complete assigned work'
            };
            
            return `
                <div class="banner-pending">
                    <div class="banner-pending-icon">
                        <span class="material-icons-outlined">pending_actions</span>
                    </div>
                    <div>
                        <div class="banner-pending-title">${actionLabels[state.caseInfo.pendingAction] || state.caseInfo.pendingAction}</div>
                        <div class="banner-pending-subtitle">${subtitles[state.currentRole]}  From ${requester.name}</div>
                    </div>
                </div>
            `;
        }

        // Role-specific AI Summary
        function renderAISummary() {
            const aiExpanded = state.sectionStates.aiSummary;
            
            return `
                <div class="ai-summary ${aiExpanded ? 'expanded' : ''}" onclick="toggleAISummary(event, this)">
                    <div class="ai-summary-header">
                        <div class="ai-summary-title">
                            <span class="material-icons-outlined" style="font-size:18px">auto_awesome</span>
                            AI Summary
                        </div>
                        <span class="material-icons-outlined expand-icon">expand_more</span>
                    </div>
                    <div class="ai-summary-content">
                        <div style="background:var(--gray-50);border-radius:var(--radius-md);padding:14px;margin-bottom:12px">
                            <p style="margin-bottom:10px"><strong>Document:</strong> Budget Proposal 2025</p>
                            <p style="margin-bottom:10px"><strong>Total Budget:</strong> K1.2 billion (12% increase from FY2024)</p>
                            <p style="margin-bottom:10px"><strong>Key Allocations:</strong></p>
                            <ul style="margin-left:20px;margin-bottom:10px">
                                <li>Infrastructure: K450M (37.5%)</li>
                                <li>Healthcare: K320M (26.7%)</li>
                                <li>Education: K280M (23.3%)</li>
                                <li>Operations: K150M (12.5%)</li>
                            </ul>
                            <p><strong>Recommendation:</strong> Approval recommended for Cabinet consideration</p>
                        </div>
                        <button class="ask-ai-btn" onclick="event.stopPropagation(); switchTab('ask-ai')">
                            <span class="material-icons-outlined" style="font-size:16px">chat</span>
                            Ask anything about this document
                        </button>
                    </div>
                </div>
            `;
        }

        // Role-based Action Items Section
        function renderActionItemsSection() {
            const roleConfig = ROLE_CONFIG[state.currentRole];
            const taskView = roleConfig.taskView;
            const isHolder = state.caseInfo.currentHolder === state.currentRole;
            
            // DTO: Hidden entirely
            if (taskView === 'hidden') {
                return '';
            }
            
            // No tasks exist yet - hide the section entirely
            // (CS will use Delegate button to create tasks, no need for empty state)
            if (state.actionItems.length === 0) {
                return '';
            }
            
            const completed = state.actionItems.filter(t => t.completed).length;
            const total = state.actionItems.length;
            const percent = Math.round((completed / total) * 100);
            const tasksExpanded = state.sectionStates.actionItems;
            
            // EA: Minimal Summary - just awareness, no details needed
            if (taskView === 'summary') {
                const ao = ROLES['ao'];
                return `
                    <div class="section-card ${tasksExpanded ? 'expanded' : ''}" id="tasks-section">
                        <div class="section-header" onclick="toggleSection('actionItems')">
                            <div class="section-title">
                                <span class="material-icons-outlined" style="font-size:18px">assignment</span>
                                Delegated Work
                                <span class="section-count" style="background:${percent === 100 ? 'var(--success-light)' : 'var(--gray-200)'};color:${percent === 100 ? 'var(--success)' : 'var(--gray-600)'}">${completed}/${total}</span>
                            </div>
                            <span class="material-icons-outlined section-toggle">expand_more</span>
                        </div>
                        <div class="section-content">
                            <div class="section-body">
                                <div class="tasks-summary">
                                    <div class="tasks-summary-icon">
                                        <span class="material-icons-outlined">person</span>
                                    </div>
                                    <div class="tasks-summary-text">
                                        <strong>${total} tasks</strong> delegated to ${ao.name}<br>
                                        <span style="color:${percent === 100 ? 'var(--success)' : 'var(--gray-500)'}">
                                            ${percent === 100 ? ' All complete' : `${completed} done, ${total - completed} pending`}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // CS: Progress Tracking View - visibility without false interactivity
            if (taskView === 'progress') {
                const ao = ROLES['ao'];
                const allDone = percent === 100;
                return `
                    <div class="section-card ${tasksExpanded ? 'expanded' : ''}" id="tasks-section">
                        <div class="section-header" onclick="toggleSection('actionItems')">
                            <div class="section-title">
                                <span class="material-icons-outlined" style="font-size:18px">trending_up</span>
                                Task Progress
                                <span class="section-count" style="background:${allDone ? 'var(--success-light)' : 'var(--warning-light)'};color:${allDone ? 'var(--success)' : '#b45309'}">${percent}%</span>
                            </div>
                            <span class="material-icons-outlined section-toggle">expand_more</span>
                        </div>
                        <div class="section-content">
                            <div class="section-body">
                                <div class="progress-tracker">
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width:${percent}%"></div>
                                    </div>
                                    ${state.actionItems.map(item => `
                                        <div class="progress-item ${item.completed ? 'done' : ''}">
                                            <div class="progress-indicator ${item.completed ? 'done' : 'pending'}">
                                                ${item.completed ? '<span class="material-icons-outlined">check</span>' : ''}
                                            </div>
                                            <span class="progress-task-title">${item.title}</span>
                                        </div>
                                    `).join('')}
                                    <div class="progress-assignee">
                                        <div class="progress-assignee-avatar" style="background:${ao.color}">${ao.initials}</div>
                                        <span>Assigned to <strong>${ao.name}</strong></span>
                                        ${!allDone ? '<span style="margin-left:auto;color:var(--warning);font-size:11px">In progress</span>' : '<span style="margin-left:auto;color:var(--success);font-size:11px"> Complete</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // AO: Interactive Checkboxes - full agency
            if (taskView === 'interactive') {
                const incomplete = total - completed;
                const showAll = state.showAllTasks;
                const displayTasks = showAll ? state.actionItems : state.actionItems.slice(0, 3);
                const hasMore = state.actionItems.length > 3;
                const allDone = incomplete === 0;
                
                // Get assignment info
                const assignedBy = state.taskAssignment.assignedBy ? ROLES[state.taskAssignment.assignedBy] : null;
                const assignedAt = state.taskAssignment.assignedAt || '';
                
                return `
                    <div class="section-card ${tasksExpanded ? 'expanded' : ''}" id="tasks-section">
                        <div class="section-header" onclick="toggleSection('actionItems')">
                            <div class="section-title">
                                <span class="material-icons-outlined" style="font-size:18px">checklist</span>
                                Your Tasks
                                <span class="section-count" style="background:${allDone ? 'var(--success-light)' : 'var(--primary-light)'};color:${allDone ? 'var(--success)' : 'var(--primary)'}">
                                    ${allDone ? ' Done' : `${incomplete} remaining`}
                                </span>
                            </div>
                            <span class="material-icons-outlined section-toggle">expand_more</span>
                        </div>
                        <div class="section-content">
                            <div class="section-body">
                                ${assignedBy ? `
                                    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--gray-50);border-radius:var(--radius-md);margin-bottom:12px;font-size:12px;color:var(--gray-600)">
                                        <div style="width:24px;height:24px;border-radius:50%;background:${assignedBy.color};display:flex;align-items:center;justify-content:center;color:white;font-size:9px;font-weight:600">${assignedBy.initials}</div>
                                        Assigned by <strong>${assignedBy.name}</strong>  ${assignedAt}
                                    </div>
                                ` : ''}
                                ${allDone ? `
                                    <div style="text-align:center;padding:16px;background:var(--success-light);border-radius:var(--radius-md);margin-bottom:12px">
                                        <span class="material-icons-outlined" style="font-size:32px;color:var(--success)">task_alt</span>
                                        <p style="color:var(--success);font-weight:600;margin-top:4px">All tasks complete!</p>
                                        <p style="color:var(--gray-600);font-size:12px">Ready to submit to Chief Secretary</p>
                                    </div>
                                ` : ''}
                                ${displayTasks.map(item => `
                                    <div class="task-item ${item.completed ? 'completed' : ''}">
                                        <div class="task-checkbox ${item.completed ? 'checked' : ''}" onclick="toggleTask(${item.id})">
                                            ${item.completed ? '<span class="material-icons-outlined">check</span>' : ''}
                                        </div>
                                        <div>
                                            <div class="task-title">${item.title}</div>
                                            <div class="task-meta">${item.completed ? ' Completed' : 'Click to mark complete'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${hasMore ? `
                                    <div class="see-all-link" onclick="event.stopPropagation(); toggleShowAllTasks()">
                                        <span class="material-icons-outlined" style="font-size:16px">${showAll ? 'expand_less' : 'expand_more'}</span>
                                        ${showAll ? 'Show less' : `Show all ${state.actionItems.length} tasks`}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return '';
        }

        // Comments Section
        function renderCommentsSection() {
            // Use state for expand/collapse - default to expanded only on first render
            const commentsExpanded = state.sectionStates.comments;
            const showAllComments = state.showAllComments;
            const displayComments = showAllComments ? state.comments : state.comments.slice(0, 2);
            const hasMoreComments = state.comments.length > 2;
            
            return `
                <div class="section-card ${commentsExpanded ? 'expanded' : ''}" id="comments-section">
                    <div class="section-header" onclick="toggleSection('comments')">
                        <div class="section-title">
                            <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                            Comments
                            <span class="section-count">${state.comments.length}</span>
                        </div>
                        <span class="material-icons-outlined section-toggle">expand_more</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            ${state.comments.length === 0 
                                ? '<div class="empty-state">No comments yet</div>'
                                : displayComments.map(c => {
                                    const author = ROLES[c.author];
                                    const recipient = c.recipient ? ROLES[c.recipient] : null;
                                    const linkedDoc = c.linkedDocId ? state.documents.find(d => d.id === c.linkedDocId) : null;
                                    return `
                                        <div class="comment-item">
                                            <div class="comment-header">
                                                <div class="comment-avatar" style="background:${author.color}">${author.initials}</div>
                                                <div class="comment-meta-wrapper">
                                                    <div class="comment-author-line">
                                                        <span class="comment-author">${author.name}</span>
                                                        ${recipient ? `
                                                            <span class="comment-arrow"></span>
                                                            <span class="comment-recipient" style="background:${recipient.color}">${recipient.initials}</span>
                                                        ` : ''}
                                                        <span class="comment-time"> ${c.timestamp}</span>
                                                    </div>
                                                    ${linkedDoc ? `
                                                        <div class="comment-linked-doc" onclick="selectDoc('${linkedDoc.id}')">
                                                            <span class="material-icons-outlined" style="font-size:12px">attach_file</span>
                                                            Re: ${linkedDoc.name}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            <div class="comment-text">${c.text}</div>
                                        </div>
                                    `;
                                }).join('')}
                            ${hasMoreComments && commentsExpanded ? `
                                <div class="see-all-link" onclick="event.stopPropagation(); toggleShowAllComments()">
                                    <span class="material-icons-outlined" style="font-size:16px">${showAllComments ? 'expand_less' : 'expand_more'}</span>
                                    ${showAllComments ? 'Show less' : `Show all ${state.comments.length} comments`}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Documents Section - Role-aware compact view
        function renderDocumentsSection() {
            const docsExpanded = state.sectionStates.documents;
            const docTypeIcons = { pdf: 'picture_as_pdf', excel: 'table_chart', word: 'description' };
            const role = state.currentRole;
            
            // Get all documents from new data model
            const originalDoc = state.documents.find(d => d.status === 'original');
            const submissions = state.submissions || [];
            const drafts = state.drafts || [];
            
            // Build display list based on role
            let displayDocs = [];
            let sectionTitle = 'Documents';
            let sectionIcon = 'folder_open';
            let totalCount = 1; // Original doc
            let hasNewItems = false;
            
            if (role === 'cs') {
                // CS sees received documents first
                sectionTitle = 'Documents';
                sectionIcon = 'inbox';
                const latestSubmission = submissions.filter(s => s.submittedTo === 'cs').sort((a, b) => b.round - a.round)[0];
                if (latestSubmission) {
                    hasNewItems = !latestSubmission.viewedBy.includes('cs');
                    latestSubmission.documents.slice(0, 2).forEach(doc => {
                        displayDocs.push({
                            ...doc,
                            isNew: hasNewItems,
                            fromSubmission: true,
                            submissionId: latestSubmission.id,
                            sender: ROLES[latestSubmission.submittedBy]
                        });
                    });
                    totalCount += latestSubmission.documents.length;
                }
                if (displayDocs.length < 3 && originalDoc) {
                    displayDocs.push({ ...originalDoc, isOriginal: true });
                }
            } else if (role === 'ao') {
                // AO sees their drafts and submissions
                sectionTitle = 'Your Documents';
                sectionIcon = 'drive_file_move';
                drafts.slice(0, 2).forEach(doc => {
                    displayDocs.push({ ...doc, isDraft: true });
                });
                const mySubmission = submissions.filter(s => s.submittedBy === 'ao').sort((a, b) => b.round - a.round)[0];
                if (mySubmission && displayDocs.length < 2) {
                    mySubmission.documents.slice(0, 2 - displayDocs.length).forEach(doc => {
                        displayDocs.push({
                            ...doc,
                            isSubmitted: true,
                            status: mySubmission.status,
                            round: mySubmission.round
                        });
                    });
                }
                if (displayDocs.length < 3 && originalDoc) {
                    displayDocs.push({ ...originalDoc, isOriginal: true });
                }
                totalCount = drafts.length + submissions.flatMap(s => s.documents).length + 1;
            } else {
                // EA/DTO see original primarily
                sectionTitle = role === 'ea' ? 'Incoming Document' : 'Your Submission';
                sectionIcon = role === 'ea' ? 'move_to_inbox' : 'check_circle';
                if (originalDoc) displayDocs.push({ ...originalDoc, isOriginal: true });
            }
            
            // Show upload button only for current holder (AO)
            const isHolder = state.caseInfo.currentHolder === state.currentRole;
            const canUpload = isHolder && role === 'ao';
            const uploadBtn = canUpload ? `
                <button class="section-action-btn" onclick="event.stopPropagation(); openModal('upload-modal')" title="Upload document">
                    <span class="material-icons-outlined">upload_file</span>
                </button>
            ` : '';
            
            return `
                <div class="section-card ${docsExpanded ? 'expanded' : ''}" id="documents-section">
                    <div class="section-header" onclick="toggleSection('documents')">
                        <div class="section-title">
                            <span class="material-icons-outlined" style="font-size:18px">${sectionIcon}</span>
                            ${sectionTitle}
                            ${hasNewItems ? '<span class="doc-badge-new" style="margin-left:8px">New</span>' : `<span class="section-count">${totalCount}</span>`}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            ${uploadBtn}
                            <span class="material-icons-outlined section-toggle">expand_more</span>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            ${displayDocs.length === 0 ? `
                                <div class="empty-state">No documents available</div>
                            ` : displayDocs.map(doc => {
                                const isViewing = doc.id === state.selectedDocId;
                                
                                // Determine status label and class
                                let statusLabel = '';
                                let statusClass = 'original';
                                
                                if (doc.isOriginal) {
                                    statusLabel = role === 'dto' ? ' Received' : 'Original';
                                    statusClass = role === 'dto' ? 'submitted' : 'original';
                                } else if (doc.isDraft) {
                                    statusLabel = 'Draft';
                                    statusClass = 'draft';
                                } else if (doc.isNew) {
                                    statusLabel = 'New';
                                    statusClass = 'new';
                                } else if (doc.fromSubmission) {
                                    statusLabel = `From ${doc.sender.shortName}`;
                                    statusClass = 'received';
                                } else if (doc.isSubmitted) {
                                    statusLabel = doc.status === 'returned' ? 'Needs Revision' : 'Submitted';
                                    statusClass = doc.status === 'returned' ? 'revision' : 'submitted';
                                }
                                
                                // Meta info
                                let metaInfo = doc.size;
                                if (doc.isOriginal) {
                                    metaInfo += `  ${doc.uploadedAt}`;
                                } else if (doc.isDraft) {
                                    metaInfo += '  Only visible to you';
                                } else if (doc.fromSubmission) {
                                    metaInfo += `  ${doc.uploadedAt}`;
                                }
                                
                                const clickHandler = doc.fromSubmission 
                                    ? `selectSubmissionDoc('${doc.submissionId}', '${doc.id}')`
                                    : `selectDoc('${doc.id}')`;
                                
                                return `
                                    <div class="doc-card ${isViewing ? 'active' : ''} ${doc.isNew ? 'has-new' : ''}" onclick="${clickHandler}" ${doc.isNew ? 'style="border-left:3px solid #f59e0b"' : ''}>
                                        <div class="doc-card-icon ${doc.type}">
                                            <span class="material-icons-outlined">${docTypeIcons[doc.type] || 'description'}</span>
                                        </div>
                                        <div class="doc-card-content">
                                            <div class="doc-card-header">
                                                <span class="doc-card-name">${doc.name}</span>
                                                ${doc.isNew 
                                                    ? '<span class="doc-badge-new">New</span>'
                                                    : `<span class="doc-card-badge ${statusClass}">${statusLabel}</span>`
                                                }
                                            </div>
                                            <div class="doc-card-meta">
                                                <span>${metaInfo}</span>
                                            </div>
                                        </div>
                                        <div class="doc-card-actions">
                                            <button class="doc-card-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${doc.id}')" title="Add comment">
                                                <span class="material-icons-outlined">chat_bubble_outline</span>
                                            </button>
                                            ${isViewing ? '<span class="doc-card-viewing">Viewing</span>' : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            <div class="see-all-link" onclick="event.stopPropagation(); switchTab('documents')">
                                <span class="material-icons-outlined" style="font-size:16px">open_in_new</span>
                                ${totalCount > 3 ? `View all ${totalCount} documents` : 'View all documents'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // =============================================
        // SECTION INTERACTIONS
        // =============================================
        
        function toggleSection(sectionKey) {
            state.sectionStates[sectionKey] = !state.sectionStates[sectionKey];
            renderDetailsTab();
        }

        function toggleAISummary(event, el) {
            if (event.target.closest('.ask-ai-btn')) return;
            state.sectionStates.aiSummary = !state.sectionStates.aiSummary;
            el.classList.toggle('expanded');
        }

        function toggleShowAllTasks() {
            state.showAllTasks = !state.showAllTasks;
            renderDetailsTab();
        }

        function toggleShowAllComments() {
            state.showAllComments = !state.showAllComments;
            renderDetailsTab();
        }

        function toggleTask(taskId) {
            const task = state.actionItems.find(t => t.id === taskId);
            if (!task || state.currentRole !== 'ao') return;
            
            task.completed = !task.completed;
            
            if (task.completed) {
                state.events.unshift({
                    id: Date.now(),
                    type: 'completed',
                    actor: state.currentRole,
                    note: `Completed: "${task.title}"`,
                    timestamp: 'Just now'
                });
                showToast('Task completed!', 'success');
            }
            
            renderDetailsTab();
            renderEventLog();
        }

        function goToEventLog() {
            state.highlightLatestEvent = true;
            switchTab('event-log');
            setTimeout(() => { state.highlightLatestEvent = false; renderEventLog(); }, 2000);
        }
        
        function goToComments() {
            // Switch to Details tab and expand comments section
            switchTab('details');
            state.sectionStates.comments = true;
            renderDetailsTab();
            
            // Scroll to comments section
            setTimeout(() => {
                const commentsSection = document.getElementById('comments-section');
                if (commentsSection) {
                    commentsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Brief highlight
                    commentsSection.style.boxShadow = '0 0 0 3px rgba(37, 99, 235, 0.3)';
                    setTimeout(() => { commentsSection.style.boxShadow = ''; }, 2000);
                }
            }, 100);
        }

        // =============================================
        // EVENT LOG - ACTIVITY TIMELINE
        // =============================================
        
        function renderEventLog() {
            const container = document.getElementById('event-log-tab');
            
            // Action verb configuration
            const verbConfig = {
                created: { verb: 'registered', suffix: 'this case', dotState: 'completed' },
                forwarded: { verb: 'forwarded', suffix: '', dotState: 'completed' },
                delegated: { verb: 'delegated', suffix: '', dotState: 'milestone' },
                submitted: { verb: 'completed & forwarded', suffix: '', dotState: 'completed' },
                returned: { verb: 'sent back', suffix: '', dotState: 'sent-back' },
                comment: { verb: 'added a note', suffix: '', dotState: 'completed' },
                uploaded: { verb: 'uploaded', suffix: 'a document', dotState: 'completed' },
                completed: { verb: 'completed', suffix: 'a task', dotState: 'completed' },
                closed: { verb: 'approved', suffix: '', dotState: 'approved' },
                rejected: { verb: 'rejected', suffix: 'this case', dotState: 'rejected' },
                priority_changed: { verb: 'changed priority', suffix: '', dotState: 'completed' },
                viewed: { verb: 'viewed', suffix: 'this case', dotState: 'completed' }
            };
            
            let events = [...state.events];
            let hiddenCount = 0;
            
            // Collapse if more than 5 events
            if (events.length > 5 && !state.eventsExpanded) {
                const visible = [events[0], events[1], ...events.slice(-2)];
                hiddenCount = events.length - 4;
                events = visible;
            }
            
            // Calculate durations between events (for full list)
            const fullEvents = [...state.events];
            const durations = {};
            for (let i = 0; i < fullEvents.length - 1; i++) {
                // Duration = time from previous event to this event
                // For prototype, we'll simulate based on event types
                durations[fullEvents[i].id] = getSimulatedDuration(fullEvents[i].type, i);
            }
            
            let html = events.map((event, idx) => {
                const config = verbConfig[event.type] || { verb: 'performed action', suffix: '', dotState: 'completed' };
                const actor = ROLES[event.actor];
                const target = event.target ? ROLES[event.target] : null;
                
                // "You" personalization
                const isActorYou = event.actor === state.currentRole;
                const isTargetYou = event.target === state.currentRole;
                const involvesYou = isActorYou || isTargetYou;
                
                // Build action line
                const actorHtml = `<span class="event-actor ${isActorYou ? 'is-you' : ''}">${isActorYou ? 'You' : actor.name}</span>`;
                const verbHtml = `<span class="event-verb">${config.verb}</span>`;
                const suffixHtml = config.suffix ? `<span class="event-suffix"> ${config.suffix}</span>` : '';
                const targetHtml = target ? ` to <span class="event-target ${isTargetYou ? 'is-you' : ''}">${isTargetYou ? 'you' : target.name}</span>` : '';
                
                const actionLine = `${actorHtml} ${verbHtml}${targetHtml}${suffixHtml}`;
                
                // Determine dot state
                let dotState = config.dotState;
                if (idx === 0 && state.caseInfo.status === 'active') {
                    dotState = 'active'; // Current/latest event
                }
                
                // Check if this is the current holder's latest action
                const isHighlighted = idx === 0 && state.highlightLatestEvent && ['forwarded', 'delegated', 'submitted', 'returned'].includes(event.type);
                
                // Duration badge (skip for first/oldest event)
                const duration = durations[event.id];
                let durationHtml = '';
                if (duration && event.type !== 'created' && event.type !== 'viewed' && event.type !== 'comment') {
                    const durationClass = duration.minutes < 60 ? 'fast' : (duration.minutes < 240 ? 'normal' : 'slow');
                    durationHtml = `
                        <div class="event-duration ${durationClass}">
                            <span class="material-icons-outlined">schedule</span>
                            ${duration.display}
                        </div>
                    `;
                }
                
                // Status badge for terminal events
                let statusBadge = '';
                if (idx === 0 && (event.type === 'closed' || (state.caseInfo.status === 'closed'))) {
                    statusBadge = '<span class="event-status-badge completed">Completed</span>';
                } else if (idx === 0 && event.type === 'rejected') {
                    statusBadge = '<span class="event-status-badge rejected">Rejected</span>';
                }
                
                // Note/Instructions content
                let contentHtml = '';
                if (event.note && event.type !== 'created') {
                    if (event.type === 'delegated') {
                        // Yellow instructions block for delegations
                        contentHtml = `
                            <div class="event-instructions">
                                <div class="event-instructions-label">Instructions</div>
                                <div class="event-instructions-text">${event.note}</div>
                            </div>
                        `;
                    } else if (event.type === 'uploaded') {
                        // Show uploaded document as attachment card
                        const fileName = event.note;
                        const fileType = fileName.endsWith('.xlsx') ? 'excel' : (fileName.endsWith('.docx') ? 'word' : 'pdf');
                        const fileIcon = fileType === 'pdf' ? 'picture_as_pdf' : (fileType === 'excel' ? 'table_chart' : 'description');
                        const clickHandler = event.docId ? `onclick="viewDocFromEventLog('${event.docId}')"` : '';
                        contentHtml = `
                            <div class="event-attachment" ${clickHandler}>
                                <div class="event-attachment-icon ${fileType}">
                                    <span class="material-icons-outlined">${fileIcon}</span>
                                </div>
                                <div class="event-attachment-info">
                                    <div class="event-attachment-name">${fileName}</div>
                                    <div class="event-attachment-size">Draft</div>
                                </div>
                                <div class="event-attachment-download">
                                    <span class="material-icons-outlined">download</span>
                                </div>
                            </div>
                        `;
                    } else {
                        // Gray note block for others - clickable to view in Comments
                        contentHtml = `<div class="event-note" onclick="goToComments()" title="View in Comments section">${event.note}</div>`;
                    }
                }
                
                // Attached documents (for submitted events)
                let attachmentHtml = '';
                if (event.type === 'submitted' && event.docs && event.docs.length > 0) {
                    attachmentHtml = event.docs.map(docId => {
                        const doc = state.documents.find(d => d.id === docId);
                        if (!doc) return '';
                        const iconType = doc.type === 'pdf' ? 'pdf' : (doc.type === 'excel' ? 'excel' : 'word');
                        const icon = doc.type === 'pdf' ? 'picture_as_pdf' : (doc.type === 'excel' ? 'table_chart' : 'description');
                        return `
                            <div class="event-attachment" onclick="viewDocFromEventLog('${doc.id}')">
                                <div class="event-attachment-icon ${iconType}">
                                    <span class="material-icons-outlined">${icon}</span>
                                </div>
                                <div class="event-attachment-info">
                                    <div class="event-attachment-name">${doc.name}</div>
                                    <div class="event-attachment-size">${doc.size}</div>
                                </div>
                                <div class="event-attachment-download">
                                    <span class="material-icons-outlined">download</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Show more button after second visible event
                let showMore = '';
                if (idx === 1 && hiddenCount > 0) {
                    showMore = `<div class="show-more-events" onclick="expandEvents()"><span class="material-icons-outlined" style="font-size:18px">unfold_more</span>Show ${hiddenCount} more activities</div>`;
                }
                
                // Timestamp display
                const timestampHtml = statusBadge || `<span class="event-time">${event.timestamp}</span>`;
                
                return `
                    ${showMore}
                    <div class="event-item ${isHighlighted ? 'highlighted' : ''}">
                        <div class="event-dot ${dotState} ${involvesYou ? 'involves-you' : ''}"></div>
                        <div class="event-content">
                            <div class="event-header">
                                <div class="event-action-line">${actionLine}</div>
                                ${timestampHtml}
                            </div>
                            ${durationHtml}
                            ${contentHtml}
                            ${attachmentHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="event-log">${html}</div>`;
        }
        
        // Helper function to get simulated duration for prototype
        function getSimulatedDuration(eventType, index) {
            // Simulate realistic durations based on event type
            const baseDurations = {
                forwarded: [15, 30, 45],
                delegated: [10, 20, 30],
                submitted: [120, 240, 360],
                returned: [60, 120, 180],
                completed: [30, 60, 90],
                closed: [15, 30, 45],
                viewed: null,
                comment: null,
                created: null
            };
            
            const durations = baseDurations[eventType];
            if (!durations) return null;
            
            const minutes = durations[index % durations.length];
            
            if (minutes < 60) {
                return { minutes, display: `${minutes}m` };
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return { minutes, display: mins > 0 ? `${hours}h ${mins}m` : `${hours}h` };
            } else {
                const days = Math.floor(minutes / 1440);
                const hours = Math.floor((minutes % 1440) / 60);
                return { minutes, display: hours > 0 ? `${days}d ${hours}h` : `${days}d` };
            }
        }

        function expandEvents() {
            state.eventsExpanded = true;
            renderEventLog();
        }

        // =============================================
        // DOCUMENTS TAB - ROLE-AWARE VIEWS
        // =============================================
        
        function renderDocumentsTab() {
            const container = document.getElementById('documents-tab');
            const role = state.currentRole;
            const docTypeIcons = { pdf: 'picture_as_pdf', excel: 'table_chart', word: 'description' };
            
            // Get all document data
            const originalDoc = state.documents.find(d => d.status === 'original');
            const submissions = state.submissions || [];
            const drafts = state.drafts || [];
            
            // Role-specific rendering
            let html = '';
            
            if (role === 'cs') {
                // CHIEF SECRETARY VIEW
                // Primary question: "What did I receive? From whom? What's new?"
                html = renderDocumentsForCS(originalDoc, submissions, drafts, docTypeIcons);
            } else if (role === 'ao') {
                // ACTION OFFICER VIEW  
                // Primary question: "What do I need to work on? What have I prepared?"
                html = renderDocumentsForAO(originalDoc, submissions, drafts, docTypeIcons);
            } else if (role === 'ea') {
                // EXECUTIVE ASSISTANT VIEW
                // Primary question: "What's the incoming document? What's the status?"
                html = renderDocumentsForEA(originalDoc, submissions, drafts, docTypeIcons);
            } else {
                // DTO VIEW
                // Primary question: "Is my document being processed?"
                html = renderDocumentsForDTO(originalDoc, submissions, drafts, docTypeIcons);
            }
            
            container.innerHTML = html;
        }
        
        // Chief Secretary Document View
        function renderDocumentsForCS(originalDoc, submissions, drafts, icons) {
            const latestSubmission = submissions.filter(s => s.submittedTo === 'cs').sort((a, b) => b.round - a.round)[0];
            const previousSubmissions = submissions.filter(s => s.submittedTo === 'cs' && s !== latestSubmission);
            
            let html = '';
            
            // SECTION 1: Received from Action Officer (most prominent for CS)
            if (latestSubmission) {
                const sender = ROLES[latestSubmission.submittedBy];
                const isNew = !latestSubmission.viewedBy.includes('cs');
                const isUnderReview = latestSubmission.status === 'under-review';
                
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">inbox</span>
                            Received from ${sender.shortName || sender.name}
                            ${isNew ? '<span class="doc-badge-new">New</span>' : ''}
                        </div>
                        
                        <div class="submission-group">
                            <div class="submission-group-header">
                                <div class="submission-sender-avatar" style="background:${sender.color}">${sender.initials}</div>
                                <div class="submission-sender-info">
                                    <div class="submission-sender-name">${sender.name}</div>
                                    <div class="submission-sender-meta">
                                        Submitted ${latestSubmission.submittedAt}
                                        ${latestSubmission.round > 1 ? `<span class="doc-revision-badge">Revision ${latestSubmission.round}</span>` : ''}
                                    </div>
                                </div>
                                <div class="submission-context">
                                    <span class="material-icons-outlined">reply</span>
                                    ${latestSubmission.inResponseTo}
                                </div>
                            </div>
                            
                            ${latestSubmission.documents.map(doc => {
                                const isActive = doc.id === state.selectedDocId;
                                return `
                                    <div class="document-card ${isNew ? 'has-new' : ''} ${isActive ? 'active' : ''}" onclick="selectSubmissionDoc('${latestSubmission.id}', '${doc.id}')">
                                        <div class="doc-icon ${doc.type}"><span class="material-icons-outlined">${icons[doc.type]}</span></div>
                                        <div class="doc-details">
                                            <div class="doc-name">${doc.name}</div>
                                            <div class="doc-meta">${doc.size}  ${doc.uploadedAt}</div>
                                            <div class="doc-badges">
                                                ${isNew ? '<span class="doc-badge-new">New</span>' : '<span class="doc-status received">Received</span>'}
                                            </div>
                                        </div>
                                        <button class="doc-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${doc.id}')" title="Add comment">
                                            <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                                        </button>
                                        <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                            <span class="material-icons-outlined" style="font-size:18px">download</span>
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                            
                            ${previousSubmissions.length > 0 ? `
                                <div class="previous-submissions" id="prev-submissions">
                                    <div class="previous-submissions-header" onclick="togglePreviousSubmissions()">
                                        <span class="material-icons-outlined">expand_more</span>
                                        ${previousSubmissions.length} previous submission${previousSubmissions.length > 1 ? 's' : ''}
                                    </div>
                                    <div class="previous-submissions-list">
                                        ${previousSubmissions.map(sub => sub.documents.map(doc => `
                                            <div class="previous-doc-item" onclick="selectSubmissionDoc('${sub.id}', '${doc.id}')">
                                                <span class="material-icons-outlined">${icons[doc.type]}</span>
                                                <span class="previous-doc-name">${doc.name}</span>
                                                <span class="previous-doc-status">${sub.status === 'returned' ? 'Returned' : 'Round ' + sub.round}</span>
                                            </div>
                                        `).join('')).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                // No submissions yet
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">inbox</span>
                            Received Documents
                        </div>
                        <div class="doc-empty-state">
                            <span class="material-icons-outlined">hourglass_empty</span>
                            <div class="doc-empty-state-text">No submissions yet</div>
                            <div class="doc-empty-state-hint">Documents from Action Officers will appear here</div>
                        </div>
                    </div>
                `;
            }
            
            // SECTION 2: Original Case Document (reference)
            if (originalDoc) {
                const uploader = ROLES[originalDoc.uploadedBy];
                const isActive = originalDoc.id === state.selectedDocId;
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">description</span>
                            Case Document
                        </div>
                        <div class="document-card original ${isActive ? 'active' : ''}" onclick="selectDoc('${originalDoc.id}')">
                            <div class="doc-icon ${originalDoc.type}"><span class="material-icons-outlined">${icons[originalDoc.type]}</span></div>
                            <div class="doc-details">
                                <div class="doc-name">${originalDoc.name}</div>
                                <div class="doc-meta">${originalDoc.size}  Registered by ${uploader.name}  ${originalDoc.uploadedAt}</div>
                                <span class="doc-status original">Original</span>
                            </div>
                            <button class="doc-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${originalDoc.id}')" title="Add comment">
                                <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                            </button>
                            <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                <span class="material-icons-outlined" style="font-size:18px">download</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Action Officer Document View
        function renderDocumentsForAO(originalDoc, submissions, drafts, icons) {
            // AO's own submissions
            const mySubmissions = submissions.filter(s => s.submittedBy === 'ao');
            const latestSubmission = mySubmissions.sort((a, b) => b.round - a.round)[0];
            
            let html = '';
            
            // Check if AO is the current holder (can upload)
            const isHolder = state.caseInfo.currentHolder === 'ao';
            const uploadBtn = isHolder ? `
                <button class="section-action-btn" onclick="openModal('upload-modal')" title="Upload document" style="margin-left:auto;width:28px;height:28px;background:var(--gray-100);border:1px solid var(--gray-200);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center">
                    <span class="material-icons-outlined" style="font-size:16px">add</span>
                </button>
            ` : '';
            
            // SECTION 1: Your Documents (drafts and submitted)
            html += `
                <div class="doc-section">
                    <div class="doc-section-title">
                        <span class="material-icons-outlined" style="font-size:16px">drive_file_move</span>
                        Your Documents
                        ${uploadBtn}
                    </div>
            `;
            
            // Show drafts first
            if (drafts.length > 0) {
                html += drafts.map(doc => {
                    const isActive = doc.id === state.selectedDocId;
                    return `
                        <div class="document-card ${isActive ? 'active' : ''}" onclick="selectDoc('${doc.id}')">
                            <div class="doc-icon ${doc.type}"><span class="material-icons-outlined">${icons[doc.type]}</span></div>
                            <div class="doc-details">
                                <div class="doc-name">${doc.name}</div>
                                <div class="doc-meta">${doc.size}  ${doc.uploadedAt}</div>
                                <div class="doc-badges">
                                    <span class="doc-status draft">Draft</span>
                                    <span style="font-size:11px;color:var(--gray-500)">Only visible to you</span>
                                </div>
                            </div>
                            <button class="doc-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${doc.id}')" title="Add comment">
                                <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                            </button>
                            <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                <span class="material-icons-outlined" style="font-size:18px">download</span>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            // Show latest submission
            if (latestSubmission) {
                const recipient = ROLES[latestSubmission.submittedTo];
                const statusLabel = latestSubmission.status === 'returned' ? 'Needs Revision' : 
                                   latestSubmission.status === 'under-review' ? 'Submitted' : 'Accepted';
                const statusClass = latestSubmission.status === 'returned' ? 'revision' : 'submitted';
                
                html += latestSubmission.documents.map(doc => {
                    const isActive = doc.id === state.selectedDocId;
                    return `
                        <div class="document-card ${isActive ? 'active' : ''}" onclick="selectSubmissionDoc('${latestSubmission.id}', '${doc.id}')">
                            <div class="doc-icon ${doc.type}"><span class="material-icons-outlined">${icons[doc.type]}</span></div>
                            <div class="doc-details">
                                <div class="doc-name">${doc.name}</div>
                                <div class="doc-meta">${doc.size}  Sent to ${recipient.shortName}  ${doc.uploadedAt}</div>
                                <div class="doc-badges">
                                    <span class="doc-status ${statusClass}">${statusLabel}</span>
                                    ${latestSubmission.round > 1 ? `<span class="doc-revision-badge">v${latestSubmission.round}</span>` : ''}
                                </div>
                                ${latestSubmission.status === 'returned' && latestSubmission.returnReason ? `
                                    <div class="doc-source" style="color:#b45309;margin-top:8px">
                                        <span class="material-icons-outlined" style="font-size:14px">info</span>
                                        ${latestSubmission.returnReason}
                                    </div>
                                ` : ''}
                            </div>
                            <button class="doc-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${doc.id}')" title="Add comment">
                                <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                            </button>
                            <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                <span class="material-icons-outlined" style="font-size:18px">download</span>
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            // Empty state if no documents
            if (drafts.length === 0 && !latestSubmission) {
                html += `
                    <div class="doc-empty-state">
                        <span class="material-icons-outlined">upload_file</span>
                        <div class="doc-empty-state-text">No documents yet</div>
                        <div class="doc-empty-state-hint">Upload documents to prepare your submission</div>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // SECTION 2: Reference Document (Original)
            if (originalDoc) {
                const uploader = ROLES[originalDoc.uploadedBy];
                const isActive = originalDoc.id === state.selectedDocId;
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">description</span>
                            Reference Document
                        </div>
                        <div class="document-card original ${isActive ? 'active' : ''}" onclick="selectDoc('${originalDoc.id}')">
                            <div class="doc-icon ${originalDoc.type}"><span class="material-icons-outlined">${icons[originalDoc.type]}</span></div>
                            <div class="doc-details">
                                <div class="doc-name">${originalDoc.name}</div>
                                <div class="doc-meta">${originalDoc.size}  ${uploader.name}  ${originalDoc.uploadedAt}</div>
                                <span class="doc-status original">Original Case</span>
                            </div>
                            <button class="doc-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${originalDoc.id}')" title="Add comment">
                                <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                            </button>
                            <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                <span class="material-icons-outlined" style="font-size:18px">download</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Executive Assistant Document View
        function renderDocumentsForEA(originalDoc, submissions, drafts, icons) {
            let html = '';
            
            // SECTION 1: Incoming Document (what EA needs to forward)
            if (originalDoc) {
                const uploader = ROLES[originalDoc.uploadedBy];
                const isActive = originalDoc.id === state.selectedDocId;
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">move_to_inbox</span>
                            Incoming Document
                        </div>
                        <div class="document-card original ${isActive ? 'active' : ''}" onclick="selectDoc('${originalDoc.id}')">
                            <div class="doc-icon ${originalDoc.type}"><span class="material-icons-outlined">${icons[originalDoc.type]}</span></div>
                            <div class="doc-details">
                                <div class="doc-name">${originalDoc.name}</div>
                                <div class="doc-meta">${originalDoc.size}  From ${uploader.name}  ${originalDoc.uploadedAt}</div>
                                <span class="doc-status original">Original</span>
                                <div class="doc-source" style="margin-top:8px">
                                    <div class="doc-source-avatar" style="background:${uploader.color}">${uploader.initials}</div>
                                    Registered by ${uploader.shortName}
                                </div>
                            </div>
                            <button class="doc-action-btn" onclick="event.stopPropagation(); addCommentForDoc('${originalDoc.id}')" title="Add comment">
                                <span class="material-icons-outlined" style="font-size:18px">chat_bubble_outline</span>
                            </button>
                            <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                <span class="material-icons-outlined" style="font-size:18px">download</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // SECTION 2: Case Activity (submissions between CS and AO - read only)
            const csSubmissions = submissions.filter(s => s.submittedTo === 'cs' && s.status !== 'draft');
            if (csSubmissions.length > 0) {
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">history</span>
                            Case Documents
                            <span style="font-size:10px;color:var(--gray-400);margin-left:4px">(View only)</span>
                        </div>
                        ${csSubmissions.flatMap(sub => sub.documents).map(doc => {
                            const isActive = doc.id === state.selectedDocId;
                            const uploader = ROLES[doc.uploadedBy];
                            return `
                                <div class="document-card ${isActive ? 'active' : ''}" onclick="selectDoc('${doc.id}')" style="opacity:0.85">
                                    <div class="doc-icon ${doc.type}"><span class="material-icons-outlined">${icons[doc.type]}</span></div>
                                    <div class="doc-details">
                                        <div class="doc-name">${doc.name}</div>
                                        <div class="doc-meta">${doc.size}  From ${uploader.name}</div>
                                        <span class="doc-status submitted">From Action Officer</span>
                                    </div>
                                    <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                        <span class="material-icons-outlined" style="font-size:18px">download</span>
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            return html;
        }
        
        // Document Transfer Officer View
        function renderDocumentsForDTO(originalDoc, submissions, drafts, icons) {
            let html = '';
            
            // SECTION 1: Your Submission
            if (originalDoc) {
                const isActive = originalDoc.id === state.selectedDocId;
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">check_circle</span>
                            Your Submission
                        </div>
                        <div class="document-card original ${isActive ? 'active' : ''}" onclick="selectDoc('${originalDoc.id}')">
                            <div class="doc-icon ${originalDoc.type}"><span class="material-icons-outlined">${icons[originalDoc.type]}</span></div>
                            <div class="doc-details">
                                <div class="doc-name">${originalDoc.name}</div>
                                <div class="doc-meta">${originalDoc.size}  Submitted ${originalDoc.uploadedAt}</div>
                                <div class="doc-badges">
                                    <span class="doc-status submitted"> Received</span>
                                </div>
                            </div>
                            <button class="doc-action-btn" onclick="event.stopPropagation()" title="Download">
                                <span class="material-icons-outlined" style="font-size:18px">download</span>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // SECTION 2: Case Progress (limited visibility)
            const allSubmittedDocs = submissions.flatMap(s => s.documents);
            if (allSubmittedDocs.length > 0) {
                html += `
                    <div class="doc-section">
                        <div class="doc-section-title">
                            <span class="material-icons-outlined" style="font-size:16px">folder_shared</span>
                            Case Progress
                            <span style="font-size:10px;color:var(--gray-400);margin-left:4px">(${allSubmittedDocs.length} document${allSubmittedDocs.length > 1 ? 's' : ''} added)</span>
                        </div>
                        <div style="padding:16px;background:var(--gray-50);border-radius:8px;text-align:center">
                            <span class="material-icons-outlined" style="font-size:32px;color:var(--gray-400);margin-bottom:8px;display:block">lock</span>
                            <div style="font-size:13px;color:var(--gray-600)">Case is being processed</div>
                            <div style="font-size:12px;color:var(--gray-400);margin-top:4px">${allSubmittedDocs.length} additional document${allSubmittedDocs.length > 1 ? 's' : ''} in workflow</div>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Helper function to toggle previous submissions
        function togglePreviousSubmissions() {
            const el = document.getElementById('prev-submissions');
            if (el) el.classList.toggle('expanded');
        }
        
        // Helper to select a document from submission
        function selectSubmissionDoc(submissionId, docId) {
            // Mark as viewed
            const submission = state.submissions.find(s => s.id === submissionId);
            if (submission && !submission.viewedBy.includes(state.currentRole)) {
                submission.viewedBy.push(state.currentRole);
            }
            state.selectedDocId = docId;
            renderAll();
        }

        // =============================================
        // ASK AI TAB
        // =============================================
        
        function renderAskAITab() {
            const container = document.getElementById('ask-ai-tab');
            container.innerHTML = `
                <div class="chat-container">
                    <div class="quick-prompts">
                        <span class="quick-prompt" onclick="askQuickPrompt('Total budget?')">Total budget</span>
                        <span class="quick-prompt" onclick="askQuickPrompt('Healthcare allocation?')">Healthcare</span>
                        <span class="quick-prompt" onclick="askQuickPrompt('Key risks?')">Risks</span>
                        <span class="quick-prompt" onclick="askQuickPrompt('Recommendation?')">Recommendation</span>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message ai">
                            <div class="chat-avatar"></div>
                            <div class="chat-bubble">I've analyzed the Budget Proposal 2025. Ask me anything!</div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <input type="text" class="chat-input" id="chat-input" placeholder="Ask about this document..." onkeypress="if(event.key==='Enter')sendChat()">
                        </div>
                        <button class="chat-send-btn" onclick="sendChat()"><span class="material-icons-outlined">send</span></button>
                    </div>
                </div>
            `;
        }

        function askQuickPrompt(prompt) {
            document.getElementById('chat-input').value = prompt;
            sendChat();
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            const container = document.getElementById('chat-messages');
            const user = ROLES[state.currentRole];
            
            container.innerHTML += `<div class="chat-message user"><div class="chat-avatar" style="background:${user.color}">${user.initials}</div><div class="chat-bubble">${message}</div></div>`;
            input.value = '';
            
            setTimeout(() => {
                let response = "I'll analyze that for you...";
                const q = message.toLowerCase();
                if (q.includes('budget') || q.includes('total')) response = "Total budget: <strong>K1.2 billion</strong> (12% increase). Largest: Infrastructure K450M (37.5%).";
                else if (q.includes('healthcare')) response = "Healthcare: <strong>K320 million (26.7%)</strong>. Includes 3 new regional hospitals.";
                else if (q.includes('risk')) response = "Key risks: currency fluctuation, contractor delays, remote access challenges.";
                else if (q.includes('recommend')) response = "<strong>Approval recommended</strong> for Cabinet consideration.";
                
                container.innerHTML += `<div class="chat-message ai"><div class="chat-avatar"></div><div class="chat-bubble">${response}</div></div>`;
                container.scrollTop = container.scrollHeight;
            }, 600);
            container.scrollTop = container.scrollHeight;
        }

        // =============================================
        // ACTION BAR
        // =============================================
        
        function renderActionBar() {
            const container = document.getElementById('action-bar');
            const isHolder = state.caseInfo.currentHolder === state.currentRole;
            const isClosed = state.caseInfo.status === 'closed';
            const isRejected = state.caseInfo.status === 'rejected';
            const holder = ROLES[state.caseInfo.currentHolder];
            
            if (isClosed) {
                container.innerHTML = `
                    <div class="action-bar-info" style="background:var(--success-light);border:1px solid #86efac">
                        <span class="material-icons-outlined" style="color:var(--success)">verified</span>
                        <span style="color:var(--success);font-weight:500">Case Closed</span>
                    </div>
                `;
                return;
            }
            
            if (isRejected) {
                container.innerHTML = `
                    <div class="action-bar-info" style="background:var(--danger-light);border:1px solid #fecaca">
                        <span class="material-icons-outlined" style="color:var(--danger)">cancel</span>
                        <span style="color:var(--danger);font-weight:500">Case Rejected</span>
                    </div>
                `;
                return;
            }
            
            if (!isHolder) {
                // Enhanced non-holder view with more context
                let statusMessage = `Currently with ${holder.name}`;
                let statusIcon = 'hourglass_empty';
                let bgStyle = '';
                
                // If there are tasks and we're CS, show progress
                if (state.currentRole === 'cs' && state.actionItems.length > 0) {
                    const completed = state.actionItems.filter(t => t.completed).length;
                    const total = state.actionItems.length;
                    const percent = Math.round((completed / total) * 100);
                    
                    if (percent === 100) {
                        statusMessage = `${holder.name} has completed all tasks`;
                        statusIcon = 'check_circle';
                        bgStyle = 'background:var(--success-light);border:1px solid #86efac';
                    } else {
                        statusMessage = `${holder.name} is working (${percent}% complete)`;
                        statusIcon = 'pending';
                    }
                }
                
                container.innerHTML = `
                    <div class="action-bar-info" style="${bgStyle}">
                        <span class="material-icons-outlined">${statusIcon}</span>
                        ${statusMessage}
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            if (state.currentRole === 'dto') {
                html = `
                    <button class="primary-action" onclick="openSendModal('dto-ea')">
                        <span class="material-icons-outlined">send</span>
                        Send to Executive Assistant
                    </button>
                    <div class="secondary-actions">
                        <button class="secondary-action" onclick="openSendModal('dto-cs')">
                            <span class="material-icons-outlined" style="font-size:16px">priority_high</span>
                            Send to CS (Urgent)
                        </button>
                    </div>
                `;
            } else if (state.currentRole === 'ea') {
                html = `
                    <button class="primary-action" onclick="openSendModal('ea-cs')">
                        <span class="material-icons-outlined">send</span>
                        Forward to Chief Secretary
                    </button>
                    <div class="secondary-actions">
                        <button class="secondary-action" onclick="openSendModal('ea-sendback')">
                            <span class="material-icons-outlined" style="font-size:16px">reply</span>
                            Return to DTO
                        </button>
                    </div>
                `;
            } else if (state.currentRole === 'cs') {
                html = `
                    <button class="primary-action" onclick="openSendModal('cs-ao')">
                        <span class="material-icons-outlined">person_add</span>
                        Delegate to Action Officer
                    </button>
                    <div class="secondary-actions">
                        <button class="secondary-action" onclick="openSendModal('cs-sendback')">
                            <span class="material-icons-outlined" style="font-size:16px">reply</span>
                            Send Back
                        </button>
                        <button class="secondary-action success" onclick="openCloseModal()">
                            <span class="material-icons-outlined" style="font-size:16px">check_circle</span>
                            Close Case
                        </button>
                        <button class="secondary-action danger" onclick="openSendModal('cs-reject')">
                            <span class="material-icons-outlined" style="font-size:16px">cancel</span>
                            Reject
                        </button>
                    </div>
                `;
            } else if (state.currentRole === 'ao') {
                // Check if all tasks are complete
                const allDone = state.actionItems.length === 0 || state.actionItems.every(t => t.completed);
                const incompleteTasks = state.actionItems.filter(t => !t.completed).length;
                
                if (allDone) {
                    html = `
                        <button class="primary-action success" onclick="openSendModal('ao-cs')">
                            <span class="material-icons-outlined">upload</span>
                            Submit to Chief Secretary
                        </button>
                    `;
                } else {
                    html = `
                        <div style="text-align:center;padding:8px 0;margin-bottom:8px">
                            <span style="font-size:12px;color:var(--gray-500)">${incompleteTasks} task${incompleteTasks > 1 ? 's' : ''} remaining</span>
                        </div>
                        <button class="primary-action" onclick="openSendModal('ao-cs')" style="background:var(--gray-400)">
                            <span class="material-icons-outlined">upload</span>
                            Submit to Chief Secretary
                        </button>
                        <p style="font-size:11px;color:var(--gray-500);text-align:center;margin-top:8px">Complete tasks before submitting</p>
                    `;
                }
            }
            
            container.innerHTML = html;
        }

        // =============================================
        // SEND MODAL
        // =============================================
        
        function openSendModal(transitionKey) {
            const config = TRANSITIONS[transitionKey];
            if (!config) return;
            
            state.currentTransition = transitionKey;
            state.modalTasks = [''];
            state.modalSelectedDocs = [];
            state.modalSelectedAction = config.actions ? config.actions[0].value : null;
            
            const isReject = transitionKey === 'cs-reject';
            
            document.getElementById('send-modal-title').textContent = config.title;
            
            let html = '';
            
            // Rejection warning
            if (isReject) {
                html += `
                    <div class="rejection-warning">
                        <span class="material-icons-outlined">warning</span>
                        <div>
                            <strong>This action cannot be undone</strong>
                            <p style="margin:4px 0 0;font-size:12px;color:var(--gray-600)">The case will be permanently closed as rejected. The original sender will be notified.</p>
                        </div>
                    </div>
                `;
            }
            
            if (config.showRecipientSelect && config.recipientOptions) {
                html += `<div class="form-group"><label class="form-label">To</label><select class="form-select" id="modal-recipient">${config.recipientOptions.map(r => `<option value="${r}">${ROLES[r].name} - ${ROLES[r].title}</option>`).join('')}</select></div>`;
            } else if (config.recipient) {
                const recipient = ROLES[config.recipient];
                html += `<div class="form-group"><label class="form-label">To</label><div class="recipient-display"><div class="recipient-avatar" style="background:${recipient.color}">${recipient.initials}</div><div><div class="recipient-name">${recipient.name}</div><div class="recipient-role">${recipient.title}</div></div></div></div>`;
            }
            
            if (config.showDocSelect && !isReject) {
                const selectableDocs = getSelectableDocuments();
                const hasDrafts = state.currentRole === 'ao' && selectableDocs.length > 0;
                
                if (state.currentRole === 'ao') {
                    // AO must select drafts to submit
                    if (selectableDocs.length > 0) {
                        html += `
                            <div class="form-group">
                                <label class="form-label">Documents to Submit *</label>
                                <p class="form-helper" style="margin-bottom:8px;margin-top:0">Select at least one draft document to include</p>
                                <div class="doc-select-list" id="modal-doc-list">
                                    ${selectableDocs.map(doc => `
                                        <div class="doc-select-item is-draft" onclick="toggleDocSelect('${doc.id}', this)" data-is-draft="true">
                                            <div class="doc-select-checkbox"><span class="material-icons-outlined" style="display:none">check</span></div>
                                            <span class="doc-select-name">${doc.name}</span>
                                            <span class="doc-select-badge draft">Draft</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="form-divider"></div>
                        `;
                    } else {
                        html += `
                            <div class="form-group">
                                <label class="form-label">Documents to Submit</label>
                                <div style="padding:24px;background:var(--gray-50);border-radius:8px;text-align:center;border:1px dashed var(--gray-300)">
                                    <span class="material-icons-outlined" style="font-size:32px;color:var(--gray-400);display:block;margin-bottom:8px">upload_file</span>
                                    <p style="color:var(--gray-600);font-size:13px;margin:0">No draft documents available</p>
                                    <p style="color:var(--gray-400);font-size:12px;margin:4px 0 0">Upload documents first before submitting</p>
                                </div>
                            </div>
                            <div class="form-divider"></div>
                        `;
                    }
                } else if (selectableDocs.length > 0) {
                    // DTO/EA forwarding original
                    html += `
                        <div class="form-group">
                            <label class="form-label">Documents to Forward</label>
                            <div class="doc-select-list" id="modal-doc-list">
                                ${selectableDocs.map(doc => `
                                    <div class="doc-select-item selected" onclick="toggleDocSelect('${doc.id}', this)" data-is-draft="false">
                                        <div class="doc-select-checkbox"><span class="material-icons-outlined">check</span></div>
                                        <span class="doc-select-name">${doc.name}</span>
                                        <span class="doc-select-badge original">Original</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="form-divider"></div>
                    `;
                    // Pre-select original documents
                    state.modalSelectedDocs = selectableDocs.map(d => d.id);
                }
            }
            
            if (config.showActionSelect && config.actions) {
                html += `<div class="form-group"><label class="form-label">Action Requested</label><div class="radio-options" id="modal-actions">${config.actions.map((action, i) => `<div class="radio-option ${i === 0 ? 'selected' : ''}" onclick="selectAction('${action.value}', this)"><div class="radio-circle"><div class="radio-dot"></div></div><div><div class="radio-label">${action.label}</div><div class="radio-desc">${action.desc}</div></div></div>`).join('')}</div></div>`;
            }
            
            if (config.showTasks) {
                html += `<div class="form-group"><label class="form-label">Action Items</label><p class="form-helper" style="margin-bottom:12px;margin-top:0">Tasks for the Action Officer</p><div class="task-input-list" id="modal-task-list"><div class="task-input-item"><input type="text" placeholder="Enter task..." onchange="updateTask(0, this.value)"><button class="task-remove-btn" onclick="removeTask(0)"><span class="material-icons-outlined" style="font-size:18px">close</span></button></div></div><button class="add-task-btn" onclick="addTask()"><span class="material-icons-outlined" style="font-size:18px">add</span>Add another task</button></div><div class="form-divider"></div>`;
            }
            
            if (config.showCompletedTasks && state.actionItems.length > 0) {
                const completed = state.actionItems.filter(t => t.completed);
                const incomplete = state.actionItems.filter(t => !t.completed);
                
                let tasksHtml = `<div class="form-group"><label class="form-label">Task Summary</label>`;
                tasksHtml += `<div class="task-summary-list">`;
                
                // Show completed tasks
                if (completed.length > 0) {
                    tasksHtml += completed.map(t => `
                        <div class="task-summary-item completed">
                            <span class="material-icons-outlined" style="color:#10b981;font-size:18px">check_circle</span>
                            <span class="task-summary-title">${t.title}</span>
                            <span class="task-summary-status completed">Completed</span>
                        </div>
                    `).join('');
                }
                
                // Show incomplete tasks with warning
                if (incomplete.length > 0) {
                    tasksHtml += incomplete.map(t => `
                        <div class="task-summary-item incomplete">
                            <span class="material-icons-outlined" style="color:#f59e0b;font-size:18px">radio_button_unchecked</span>
                            <span class="task-summary-title">${t.title}</span>
                            <span class="task-summary-status incomplete">Not completed</span>
                        </div>
                    `).join('');
                }
                
                tasksHtml += `</div>`;
                
                // Warning if incomplete tasks
                if (incomplete.length > 0) {
                    tasksHtml += `
                        <div class="task-warning">
                            <span class="material-icons-outlined">warning</span>
                            <span>${incomplete.length} task${incomplete.length > 1 ? 's' : ''} not yet completed. You can still submit, but this will be visible to the Chief Secretary.</span>
                        </div>
                    `;
                }
                
                tasksHtml += `</div><div class="form-divider"></div>`;
                html += tasksHtml;
            }
            
            html += `<div class="form-group"><label class="form-label">${isReject ? 'Reason for Rejection' : config.showTasks ? 'Instructions' : 'Notes'}${isReject ? ' *' : ''}</label><textarea class="form-textarea" id="modal-notes" placeholder="${isReject ? 'Explain why this case is being rejected...' : 'Add context or instructions...'}" ${isReject ? 'required' : ''}></textarea></div>`;
            
            if ((config.showPriority || config.showDueDate) && !isReject) {
                html += `<div class="form-row">`;
                if (config.showPriority) html += `<div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="modal-priority"><option value="high" ${state.caseInfo.priority === 'high' ? 'selected' : ''}>High</option><option value="medium" ${state.caseInfo.priority === 'medium' ? 'selected' : ''}>Medium</option><option value="low" ${state.caseInfo.priority === 'low' ? 'selected' : ''}>Low</option></select></div>`;
                if (config.showDueDate) html += `<div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="modal-due-date"></div>`;
                html += `</div>`;
            }
            
            document.getElementById('send-modal-body').innerHTML = html;
            
            const submitBtn = document.getElementById('send-modal-submit');
            const isSubmit = transitionKey === 'ao-cs';
            
            if (isReject) {
                submitBtn.innerHTML = `<span class="material-icons-outlined" style="font-size:18px">cancel</span>Reject Case`;
                submitBtn.className = 'btn btn-danger';
            } else {
                submitBtn.innerHTML = `<span class="material-icons-outlined" style="font-size:18px">${isSubmit ? 'upload' : 'send'}</span>${isSubmit ? 'Submit' : 'Send'}`;
                submitBtn.className = `btn ${isSubmit ? 'btn-success' : 'btn-primary'}`;
            }
            
            openModal('send-modal');
            
            // Update draft warning on initial load
            updateDraftWarning();
        }

        function selectAction(value, el) {
            el.parentElement.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            state.modalSelectedAction = value;
        }

        function toggleDocSelect(docId, el) {
            el.classList.toggle('selected');
            const checkbox = el.querySelector('.doc-select-checkbox .material-icons-outlined');
            if (el.classList.contains('selected')) {
                state.modalSelectedDocs.push(docId);
                checkbox.style.display = 'block';
            } else {
                state.modalSelectedDocs = state.modalSelectedDocs.filter(id => id !== docId);
                checkbox.style.display = 'none';
            }
            updateDraftWarning();
        }
        
        // Update draft warning in send modal
        function updateDraftWarning() {
            const container = document.getElementById('draft-warning-container');
            const warningText = document.getElementById('draft-warning-text');
            if (!container) return;
            
            const myDrafts = getMyDraftDocuments();
            const unselectedDrafts = myDrafts.filter(d => !state.modalSelectedDocs.includes(d.id));
            
            if (unselectedDrafts.length > 0) {
                container.style.display = 'block';
                warningText.textContent = `You have ${unselectedDrafts.length} draft document${unselectedDrafts.length > 1 ? 's' : ''} not selected`;
            } else {
                container.style.display = 'none';
            }
        }

        function addTask() {
            state.modalTasks.push('');
            const list = document.getElementById('modal-task-list');
            const idx = state.modalTasks.length - 1;
            const div = document.createElement('div');
            div.className = 'task-input-item';
            div.innerHTML = `<input type="text" placeholder="Enter task..." onchange="updateTask(${idx}, this.value)"><button class="task-remove-btn" onclick="removeTask(${idx})"><span class="material-icons-outlined" style="font-size:18px">close</span></button>`;
            list.appendChild(div);
        }

        function updateTask(idx, value) { state.modalTasks[idx] = value; }

        function removeTask(idx) {
            if (state.modalTasks.length <= 1) return;
            state.modalTasks.splice(idx, 1);
            const list = document.getElementById('modal-task-list');
            list.innerHTML = state.modalTasks.map((task, i) => `<div class="task-input-item"><input type="text" placeholder="Enter task..." value="${task}" onchange="updateTask(${i}, this.value)"><button class="task-remove-btn" onclick="removeTask(${i})"><span class="material-icons-outlined" style="font-size:18px">close</span></button></div>`).join('');
        }

        function submitSend() {
            const config = TRANSITIONS[state.currentTransition];
            if (!config) return;
            
            const notes = document.getElementById('modal-notes')?.value.trim() || '';
            const isReject = state.currentTransition === 'cs-reject';
            
            // Require notes for rejection
            if (isReject && !notes) {
                showToast('Please provide a reason for rejection', 'error');
                return;
            }
            
            // AO must select at least 1 document to submit
            if (state.currentTransition === 'ao-cs') {
                if (state.modalSelectedDocs.length === 0) {
                    showToast('Please select at least one document to submit', 'error');
                    return;
                }
            }
            
            let recipientId = config.showRecipientSelect ? document.getElementById('modal-recipient')?.value : config.recipient;
            const recipient = ROLES[recipientId];
            const action = state.modalSelectedAction || config.implicitAction;
            
            const priorityEl = document.getElementById('modal-priority');
            if (priorityEl) state.caseInfo.priority = priorityEl.value;
            
            // Handle task assignment (CS delegating to AO)
            if (config.showTasks) {
                const validTasks = state.modalTasks.filter(t => t.trim());
                if (validTasks.length > 0) {
                    state.actionItems = validTasks.map((title, i) => ({ id: Date.now() + i, title, completed: false }));
                    state.taskAssignment.assignedBy = state.currentRole;
                    state.taskAssignment.assignedAt = 'Just now';
                }
            }
            
            // Handle AO submission - create submission from drafts
            if (state.currentTransition === 'ao-cs' && state.modalSelectedDocs.length > 0) {
                // Must have at least one document selected
                if (state.modalSelectedDocs.length === 0) {
                    showToast('Please select at least one document', 'error');
                    return;
                }
                
                // Get selected drafts
                const selectedDrafts = state.drafts.filter(d => state.modalSelectedDocs.includes(d.id));
                
                // Calculate round number
                const existingRounds = state.submissions.filter(s => s.submittedBy === 'ao').length;
                const round = existingRounds + 1;
                
                // Create submission record
                const newSubmission = {
                    id: 'sub_' + Date.now(),
                    round: round,
                    submittedBy: 'ao',
                    submittedTo: 'cs',
                    submittedAt: 'Just now',
                    inResponseTo: round === 1 ? 'Initial delegation' : 'Revision request',
                    status: 'under-review',
                    documents: selectedDrafts.map(d => ({
                        id: d.id,
                        name: d.name,
                        type: d.type,
                        size: d.size,
                        uploadedBy: d.uploadedBy,
                        uploadedAt: d.uploadedAt,
                        content: d.content
                    })),
                    viewedBy: []
                };
                
                state.submissions.push(newSubmission);
                
                // Remove submitted drafts from drafts array
                state.drafts = state.drafts.filter(d => !state.modalSelectedDocs.includes(d.id));
            }
            
            // Handle rejection
            if (isReject) {
                state.caseInfo.status = 'rejected';
                state.events.unshift({ id: Date.now(), type: 'rejected', actor: state.currentRole, note: notes, timestamp: 'Just now' });
                if (notes) state.comments.unshift({ id: Date.now(), author: state.currentRole, recipient: 'dto', text: `Rejection reason: ${notes}`, timestamp: 'Just now', linkedDocId: null });
                
                closeModal('send-modal');
                renderAll();
                showToast('Case rejected', 'success');
                return;
            }
            
            // Handle CS returning work to AO (mark submission as returned)
            if (state.currentTransition === 'cs-sendback' && recipientId === 'ao' && notes) {
                // Mark latest submission as returned
                const latestSubmission = state.submissions
                    .filter(s => s.submittedTo === 'cs' && s.status === 'under-review')
                    .sort((a, b) => b.round - a.round)[0];
                    
                if (latestSubmission) {
                    latestSubmission.status = 'returned';
                    latestSubmission.returnReason = notes;
                }
            }
            
            // Determine event type
            let eventType = 'forwarded';
            if (state.currentTransition === 'cs-ao') eventType = 'delegated';
            else if (state.currentTransition === 'ao-cs') eventType = 'submitted';
            else if (state.currentTransition.includes('sendback')) eventType = 'returned';
            
            // Update holder
            state.caseInfo.previousHolder = state.caseInfo.currentHolder;
            state.caseInfo.currentHolder = recipientId;
            state.caseInfo.pendingAction = action;
            state.caseInfo.pendingFrom = state.currentRole;
            
            // Add event to timeline
            const attachedDocs = state.modalSelectedDocs.length > 0 ? [...state.modalSelectedDocs] : null;
            state.events.unshift({ 
                id: Date.now(), 
                type: eventType, 
                actor: state.currentRole, 
                target: recipientId, 
                note: notes || null, 
                docs: attachedDocs,
                timestamp: 'Just now' 
            });
            
            if (notes) {
                state.comments.unshift({ 
                    id: Date.now(), 
                    author: state.currentRole, 
                    recipient: recipientId, 
                    text: notes, 
                    timestamp: 'Just now', 
                    linkedDocId: null 
                });
            }
            
            closeModal('send-modal');
            renderAll();
            showToast(`Sent to ${recipient.name}`, 'success');
        }

        function openCloseModal() { openModal('close-modal'); }

        function submitClose() {
            state.caseInfo.status = 'closed';
            state.events.unshift({ id: Date.now(), type: 'closed', actor: state.currentRole, timestamp: 'Just now' });
            closeModal('close-modal');
            renderAll();
            showToast('Case closed!', 'success');
        }

        function simulateFileSelect() {
            const types = ['pdf', 'excel', 'word'];
            const type = types[Math.floor(Math.random() * types.length)];
            const ext = { pdf: '.pdf', excel: '.xlsx', word: '.docx' }[type];
            document.getElementById('upload-name').value = `Document_${Date.now().toString().slice(-6)}${ext}`;
        }

        function submitUpload() {
            const name = document.getElementById('upload-name').value.trim();
            if (!name) { showToast('Enter document name', 'error'); return; }
            
            const type = name.endsWith('.xlsx') ? 'excel' : name.endsWith('.docx') ? 'word' : 'pdf';
            
            // Generate document content based on type
            const docContent = generateUploadedDocContent(name, type);
            
            const docId = 'draft_' + Date.now();
            const newDraft = { 
                id: docId, 
                name, 
                type, 
                size: '1.2 MB', 
                uploadedBy: state.currentRole, 
                uploadedAt: 'Just now', 
                status: 'draft',
                content: docContent 
            };
            
            // Add to drafts array (private to uploader)
            state.drafts.push(newDraft);
            
            // Add event to log
            state.events.unshift({ 
                id: Date.now(), 
                type: 'uploaded', 
                actor: state.currentRole, 
                note: name, 
                docId: docId, 
                timestamp: 'Just now' 
            });
            
            state.sectionStates.documents = true;
            
            closeModal('upload-modal');
            document.getElementById('upload-name').value = '';
            renderAll();
            showToast('Document uploaded as draft', 'success');
        }

        // Generate content for uploaded documents
        function generateUploadedDocContent(name, type) {
            const uploader = ROLES[state.currentRole];
            const cleanName = name.replace(/\.[^/.]+$/, '').replace(/_/g, ' ');
            
            if (type === 'excel') {
                return `
                    <h1>${cleanName}</h1>
                    <p class="subtitle">Spreadsheet Document<br>Uploaded by ${uploader.name}</p>
                    
                    <h2>Data Summary</h2>
                    <table>
                        <thead><tr><th>Category</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>Total</th></tr></thead>
                        <tbody>
                            <tr><td>Revenue</td><td>125,000</td><td>142,000</td><td>138,500</td><td>156,200</td><td>561,700</td></tr>
                            <tr><td>Expenses</td><td>98,000</td><td>105,000</td><td>112,000</td><td>118,000</td><td>433,000</td></tr>
                            <tr><td>Net</td><td>27,000</td><td>37,000</td><td>26,500</td><td>38,200</td><td>128,700</td></tr>
                        </tbody>
                    </table>
                    
                    <h2>Analysis Notes</h2>
                    <ul>
                        <li>Q4 shows strongest performance with 15% growth</li>
                        <li>Expense ratio maintained at target of 77%</li>
                        <li>Year-over-year improvement of 8.5%</li>
                    </ul>
                    
                    <div style="margin-top:40px;padding:20px;background:#f0fdf4;border-radius:8px">
                        <p style="color:#16a34a;font-weight:600"> Data verified and ready for review</p>
                    </div>
                `;
            } else if (type === 'word') {
                return `
                    <h1>${cleanName}</h1>
                    <p class="subtitle">Document Report<br>Prepared by ${uploader.name}</p>
                    
                    <h2>1. Introduction</h2>
                    <p>This document has been prepared in response to the requirements outlined in the original case submission. The following sections detail our findings, analysis, and recommendations for consideration.</p>
                    
                    <h2>2. Background</h2>
                    <p>Following the initial review of the Budget Proposal 2025, this supplementary document provides additional context and supporting information that may be relevant to the decision-making process.</p>
                    <p>Key considerations include alignment with existing policy frameworks, resource availability, and implementation feasibility within the proposed timeframes.</p>
                    
                    <h2>3. Key Findings</h2>
                    <ul>
                        <li>The proposed allocations are consistent with historical spending patterns</li>
                        <li>Infrastructure investments show strong potential for economic returns</li>
                        <li>Healthcare expansion addresses critical service gaps in rural areas</li>
                        <li>Education funding supports workforce development priorities</li>
                    </ul>
                    
                    <h2>4. Recommendations</h2>
                    <p>Based on our analysis, we recommend the following:</p>
                    <ul>
                        <li>Approval of the proposed budget framework</li>
                        <li>Establishment of quarterly review checkpoints</li>
                        <li>Development of detailed implementation plans by sector</li>
                        <li>Regular progress reporting to stakeholders</li>
                    </ul>
                    
                    <h2>5. Conclusion</h2>
                    <p>The Budget Proposal 2025 represents a balanced approach to meeting Papua New Guinea's development needs while maintaining fiscal responsibility. We support its progression to the next stage of approval.</p>
                    
                    <div style="margin-top:40px;padding-top:20px;border-top:2px solid #e5e7eb">
                        <p><strong>Prepared by:</strong> ${uploader.name}</p>
                        <p><strong>Role:</strong> ${uploader.title}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                    </div>
                `;
            } else {
                // PDF type
                return `
                    <h1>${cleanName}</h1>
                    <p class="subtitle">Supporting Document<br>Submitted by ${uploader.name}</p>
                    
                    <h2>Document Overview</h2>
                    <p>This document has been uploaded as supporting material for Case ${state.caseInfo.id}. It contains relevant information pertaining to the Budget Proposal 2025 review process.</p>
                    
                    <h2>Contents</h2>
                    <ul>
                        <li>Section 1: Executive Summary</li>
                        <li>Section 2: Detailed Analysis</li>
                        <li>Section 3: Supporting Data</li>
                        <li>Section 4: Recommendations</li>
                        <li>Appendix: Reference Materials</li>
                    </ul>
                    
                    <h2>Summary of Key Points</h2>
                    <p>This supplementary document provides additional context for the budget review process. The analysis contained herein supports the recommendations made in the primary proposal document.</p>
                    
                    <table>
                        <thead><tr><th>Item</th><th>Status</th><th>Notes</th></tr></thead>
                        <tbody>
                            <tr><td>Compliance Check</td><td style="color:#16a34a"> Passed</td><td>Meets all regulatory requirements</td></tr>
                            <tr><td>Financial Review</td><td style="color:#16a34a"> Passed</td><td>Figures verified and accurate</td></tr>
                            <tr><td>Policy Alignment</td><td style="color:#16a34a"> Passed</td><td>Consistent with national strategy</td></tr>
                        </tbody>
                    </table>
                    
                    <h2>Conclusion</h2>
                    <p>This supporting documentation is submitted for consideration alongside the primary Budget Proposal 2025. All information has been verified and is ready for review by the appropriate authorities.</p>
                    
                    <div style="margin-top:40px;padding-top:20px;border-top:2px solid #e5e7eb;text-align:center;color:#6b7280">
                        <p><strong>Document uploaded by:</strong> ${uploader.name}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</p>
                        <p><strong>Status:</strong> Draft - Pending Review</p>
                    </div>
                `;
            }
        }

        // =============================================
        // UTILITIES
        // =============================================
        
        function openModal(id) { 
            document.getElementById(id).classList.add('active');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // Document comment functionality
        let currentCommentDocId = null;
        
        function addCommentForDoc(docId) {
            const doc = state.documents.find(d => d.id === docId);
            if (!doc) return;
            
            currentCommentDocId = docId;
            document.getElementById('doc-comment-name').textContent = doc.name;
            document.getElementById('doc-comment-text').value = '';
            openModal('doc-comment-modal');
        }
        
        function submitDocComment() {
            const text = document.getElementById('doc-comment-text').value.trim();
            if (!text) { showToast('Enter a comment', 'error'); return; }
            
            // Comment is directed to the current holder (unless it's yourself)
            const recipientRole = state.caseInfo.currentHolder !== state.currentRole 
                ? state.caseInfo.currentHolder 
                : null;
            
            state.comments.unshift({ 
                id: Date.now(), 
                author: state.currentRole, 
                recipient: recipientRole,
                text, 
                timestamp: 'Just now',
                linkedDocId: currentCommentDocId
            });
            state.events.unshift({ 
                id: Date.now(), 
                type: 'comment', 
                actor: state.currentRole, 
                target: recipientRole, 
                note: text, 
                timestamp: 'Just now' 
            });
            state.sectionStates.comments = true;
            
            closeModal('doc-comment-modal');
            currentCommentDocId = null;
            renderAll();
            showToast('Comment added', 'success');
        }

        // Calculate days remaining until due date
        function getDaysRemaining(dueDateStr) {
            const today = new Date();
            const dueDate = new Date(dueDateStr);
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Priority dropdown toggle
        function togglePriorityDropdown(event) {
            event.stopPropagation();
            const options = document.getElementById('priority-options');
            options.classList.toggle('show');
            
            // Close on outside click
            const closeDropdown = (e) => {
                if (!e.target.closest('.priority-dropdown')) {
                    options.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            };
            setTimeout(() => document.addEventListener('click', closeDropdown), 0);
        }

        // Change priority
        function changePriority(newPriority) {
            if (state.caseInfo.priority === newPriority) return;
            
            const oldPriority = state.caseInfo.priority;
            state.caseInfo.priority = newPriority;
            
            // Log to event log
            state.events.unshift({
                id: Date.now(),
                type: 'priority_changed',
                actor: state.currentRole,
                note: `Changed priority from ${oldPriority} to ${newPriority}`,
                timestamp: 'Just now'
            });
            
            document.getElementById('priority-options')?.classList.remove('show');
            renderDetailsTab();
            renderEventLog();
            showToast(`Priority changed to ${newPriority}`, 'success');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.panel-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            if (tabName === 'ask-ai') setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
            if (tabName === 'event-log' && state.highlightLatestEvent) renderEventLog();
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="material-icons-outlined" style="font-size:20px">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>
